<?php
/**
 * <--- Copyright 2005-2011 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * @author Moises Heberle [moises@solis.coop.br]
 *
 * \b Maintainers \n
 * Arthur Lehdermann [arthur@solis.coop.br]
 * Moises Heberle [moises@solis.coop.br]
 *
 * @since
 * Class created on 16/07/2011
 */
class FrmOfertaDeUnidadeTematicaSearch extends SSearchForm
{
    public function __construct($data)
    {
        parent::__construct(null, new MedOfertaDeUnidadeTematica(), array('ofertaDeUnidadeTematicaId'));
    }

    public function defineFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $action = MIOLO::getCurrentAction();

        // Cdigo
        $fields[] = $codigo = new MTextField('ofertaDeUnidadeTematicaIdS', $this->getFormValue('ofertaDeUnidadeTematicaIdS'), _M('Cdigo da oferta do rodzio', $module), SAGU::getParameter('BASIC', 'FIELD_ID_SIZE'));
        $codigo->setJsHint(_M('Informe o cdigo do rodzio', $module));

        $fields[] = $unidadeTematica = new MLookupTextField('unidadeTematicaIdS',$this->getFormValue('unidadeTematicaId'),_M('Cdigo do rodzio'), SAGU::getParameter('BASIC', 'FIELD_ID_LOOKUP_SIZE'), '', null,'descricaoS, limbo, limbo, limbo, limbo, limbo, limbo, limbo, periodoS, tipoS', $module, 'UnidadeTematica', '', array(), true);
        
        // Descrio
        $fields[] = $descricao = new MTextField('descricaoS', $this->getFormValue('descricaoS'), _M('Descrio', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_SIZE'));
        $descricao->setJsHint(_M('Informe a descrio do rodzio', $module));
                
        // Perodo
        $fields[] = $tipo = new MSelection('periodoS', $this->getFormValue('periodoS'), _M('Perodo', $module), MedUnidadeTematica::listPeriodos());
        $tipo->setJsHint(_M('Informe o perodo', $module));

        // Tipo
        $fields[] = $tipo = new MSelection('tipoS', $this->getFormValue('tipoS'), _M('Tipo', $module), MedUnidadeTematica::listTipos());
        $tipo->setJsHint(_M('Informe o tipo do rodzio', $module));


        // Lookup de turma
        $optsTurma = array(
            'label' => _M('Turma', $module),
            'item' => 'Turma',
            'module' => 'resmedica',
        );
        $fields[] = $turmaId = new SLookupContainer('turmaId', $this->getRequestValue('turmaId'), $optsTurma);

        // Ncleos profissionais
        $fields[] = $nucleosProfissionais = new MMultiSelection('nucleosProfissionaisS', (array) $this->getFormValue('nucleosProfissionaisS'), _M('Ncleos profissionais'), MedNucleoProfissional::listRecords());
        $nucleosProfissionais->setJsHint(_M('Selecione os ncleos profissionais', $module));
        
        // nfases
        $fields[] = $enfases = new MMultiSelection('enfasesS', (array) $this->getFormValue('enfasesS'), _M('nfases'), MedEnfase::listRecords());
        $enfases->setJsHint(_M('Selecione as nfases'));

        // Perodo de ocorrncia
        $fields[] = new SBeginEndPeriod(array(
            'label' => _M('Perodo de ocorrncia', $module),
            'baseGroup' => false,
            'disposition' => 'horizontal',
            'begin' => array(
                'label' => _M('entre', $module),
                'dateId' => 'betweenInicioS'
            ),
            'end' => array(
                'label' => _M('e', $module),
                'dateId' => 'betweenFimS'
            ),
        ));
        
        parent::defineFields($fields, $module, 'GrdOfertaDeUnidadeTematicaSearch', $validators);
    }

    /**
     * Obtm os dados do form
     * @return type
     */
    public function  getTypesData()
    {
        $data = parent::getTypesData();
        $data->descricao = $this->getRequestValue('descricaoS');
        $data->periodo = $this->getRequestValue('periodoS');
        $data->tipo = $this->getRequestValue('tipoS');
        $data->nucleosProfissionais = $this->getRequestValue('nucleosProfissionaisS');
        $data->inicio = $this->getRequestValue('betweenInicioS');
        $data->fim = $this->getRequestValue('betweenFimS');
        $data->enfases = $this->getRequestValue('enfasesS');
        $data->nucleosProfissionais = $this->getRequestValue('nucleosProfissionaisS');
        $data->equipe = $this->getRequestValue('equipeS');

        return $data;
    }

    public function showInformation($args)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        $filters = new stdClass();
        $filters->ofertaDeUnidadeTematicaId = $this->getRequestValue('ofertaDeUnidadeTematicaId');
        $ut = current(MedOfertaDeUnidadeTematica::searchGrid($filters));

        // FIXME Obter dados via posicao de array nao e uma boa pratica
        $periodos = MedUnidadeTematica::listPeriodos();
        $tipos = MedUnidadeTematica::listTipos();
        $options = array(
            _M('Rodzio', $module) => $ut[3],
            _M('Tipo', $module) => $tipos[$ut[5]],
            _M('Carga horria', $module) => $ut[6],
            _M('Frequncia mnima', $module) => $ut[7],
            _M('Ncleos profissionais') => $ut[8],
            _M('nfases') => $ut[9],
            _M('Incio', $module) => $ut[10],
            _M('Fim', $module) => $ut[11]
        );
        $fields[] = new SInformationField(array(
            'value' => $options,
            'columns' => 1,
        ));

        // Get grid
        $fields[] = new MSeparator();

        $ofertaDeUnidadeTematica = new MedOfertaDeUnidadeTematica($this->getRequestValue('ofertaDeUnidadeTematicaId'));
        $grdData = new stdClass();
        $grdData->readOnly = true;
        $grid = $MIOLO->getUI()->getGrid($module, 'GrdTemaUnidadeTematica', $grdData);
        $grid->setData($ofertaDeUnidadeTematica->retornaTemasDaOfertaEmArray());
        $divGrid = new MDiv('divGridTemas', $grid);
        $divGrid->addBoxStyle('width', '100%');
        $fields[] = new MBaseGroup('baseGroupTemas', _M('Atividades do rodzio',$module), array($divGrid));

        MPopup::show('divPopup', $fields, _M('Mais informaes', $module));
    }
}
?>