<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * @author Jonas Gualberto Diel [jonas_diel@solis.coop.br]
 *
 * $version: $Id$
 *
 * \b Maintainers \n
 * Arthur Lehdermann [arthur@solis.coop.br]
 * Jonas Gualberto Diel [jonas_diel@solis.coop.br]
 *
 * @since
 * Class created on 02/06/2011
 */
class FrmMaterialReturn extends SForm
{
    public function __construct()
    {
        $module = SAGU::getFileModule(__FILE__);

        parent::__construct(_M('Devoluo de material', $module), null, null);

        // Desabilita alguns botes da MToolbar
        $this->toolbar->disableButton(MToolBar::BUTTON_NEW);
        $this->toolbar->disableButton(MToolBar::BUTTON_DELETE);
        $this->toolbar->disableButton(MToolBar::BUTTON_SEARCH);
        $this->toolbar->disableButton(MToolBar::BUTTON_PRINT);
        

        // Caso tenha um "return_to" adiciona o boto de voltar
        if ( strlen(MIOLO::_REQUEST('return_to')) > 0 )
        {
            $this->toolbar->setButtonURL(MToolBar::BUTTON_BACK, MIOLO::_REQUEST('return_to'));
            $this->toolbar->setIsPost(MToolBar::BUTTON_BACK, true);
        }
        else // Se no desabilita ele
        {
            
        }
    }

    public function defineFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        // Return to
        $returnTo = MIOLO::_REQUEST('return_to');
        $fields[] = new SHiddenField('returnTo', $returnTo);

        // Obtm o cdigo da solicitao de material
        $materialRequestId = MIOLO::_REQUEST('materialRequestId');
        if ( !strlen($materialRequestId) > 0 )
        {
            $href = (strlen($returnTo) > 0) ? $returnTo : $MIOLO->getActionURL($module, $action, null, array('function' => 'search'));
            $MIOLO->error(_M('Cdigo da solicitao de material inexistente.', $module), $href);
        }

        // Obtm a solicitao de material
        $materialRequest = new InsMaterialRequest($materialRequestId);

        // Campo oculto Cdigo da solicitao de material
        $fields[] = new MHiddenField('materialRequestId', $materialRequest->materialRequestId);

        // Obtm o emprstimo de material
        $filters = new stdClass();
        $filters->materialRequestId = $materialRequestId;

        $searchMaterialLoan = InsMaterialLoan::search($filters);
        if( !count($searchMaterialLoan) > 0)
        {
            $MIOLO->error(_M('Nenhum emprstimo encontrado para a solicitao @1', $module, $materialRequestId));
        }
        $materialLoan = $searchMaterialLoan[0];

        // BaseGroup de informaes
        $data = array(
            _M('Nome', $module) => $materialLoan->physicalPerson->name,
            _M('Retirada solicitada', $module) => $materialLoan->materialRequest->beginDate,
            _M('Devoluo solicitada', $module) => $materialLoan->materialRequest->endDate,
            _M('Tipo de material', $module) => $materialLoan->material->materialType->description,
            _M('Material', $module) => $materialLoan->material->description,
            _M('Observaes solicitao', $module) => (strlen($materialLoan->materialRequest->observation) > 0) ? $materialLoan->materialRequest->observation : "-",
            _M('Data da retirada', $module) => $materialLoan->beginDate,
            _M('Devoluo prevista', $module) => $materialLoan->expectedEndDate,
            _M('Observaes emprstimo', $module) => (strlen($materialLoan->returnObs) > 0) ? $materialLoan->returnObs : "-",
        );
        $fields[] = new SInformationField(array(
            'columns' => 1,
            'title' => _M('Dados do emprstimo', $module),
            'value' => $data ));

        // Campo oculto Cdigo do emprstimo
        $fields[] = new MHiddenField('materialLoanId', $materialLoan->materialLoanId);

        // Separator
        $fields[] = new MSeparator();

        // Campo data de devoluo
        $fields[] = new SBeginEndPeriod(array(
        'required' => true,
        'baseGroup' => false,
        'type' => 'timestamp',
        'begin' => array('enable' => false),
        'end' => array(
            'dateId' => 'endDate',
            'timeId' => 'endTime',
            'dateValue' => SAGU::getDateNow(),
            'timeValue' => SAGU::getDateNow('H:i'),
            'label' => _M('Data de devoluo', $module),
            'dateHint' => _M('Informe a data da devoluo', $module),
            'timeHint' => _M('Informe a hora da devoluo. Formato: hh:mm', $module)
        )));
        $validators[] = new MDATEDMYValidator('endDate', _M('Data de devoluo', $module), 'required');
        $validators[] = new MTIMEValidator('endTime', _M('Hora da devoluo', $module), 'required');

        // Campo observaes
        $fields[] = new MMultiLineField('returnObs', $materialLoan->returnObs, _M('Observaes', $module), null, 5, 80);

        // Separador
        $fields[] = new MSeparator();

        parent::defineFields();
        $this->SetFields($fields);
        $this->SetValidators($validators);
    }

    public function tbBtnSave_click($sender = NULL)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $action = MIOLO::getCurrentAction();

        // Obtm os dados
        $args = $this->getData();
        // Volta para a tela de onde ele veio
        $returnTo = $args->returnTo;

        // Obtm os dados
        $data = $this->getTypesData();
        try
        {
            $materialLoan = new InsMaterialLoan($data->materialLoanId);

            SDatabase::beginTransaction();
            $materialLoan->returnMaterial($data->endDate, $data->returnObs);
            SDatabase::commit();

            // Mensagem de inserido com sucesso
            $href = (strlen($returnTo) > 0) ? $returnTo : $MIOLO->getActionURL($module, $action, null, array('function' => 'search'));
            SAGU::information(_M('Devoluo realizada com sucesso!', $module), $href);
        }
        catch ( Exception $e )
        {
            // Se ocorrer erro
            SDatabase::rollback();
            $MIOLO->error($e->getMessage());
        }
    }

    public function getTypesData()
    {
        $data = new stdClass();
        $data->materialLoanId = $this->getFormValue('materialLoanId', MIOLO::_request('materialLoanId'));
        $data->endDate = $this->getFormValue('endDate', MIOLO::_request('endDate')).' '.$this->getFormValue('endTime', MIOLO::_request('endTime'));
        $data->returnObs = $this->getFormValue('returnObs', MIOLO::_request('returnObs'));
        return $data;
    }
}
?>