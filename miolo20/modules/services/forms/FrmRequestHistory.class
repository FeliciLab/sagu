<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Formulrio para consultar os estgios que j foram feitos pelo aluno
 *
 * @author Artur Bernardo Koefender [artur@solis.coop.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Artur Bernardo Koefender [artur@solis.coop.br]
 *
 * @since
 * Class created on 27/05/2013
 */
class FrmRequestHistory extends SForm
{
    
    public $personData;
    
    public function __construct()
    {
        $MIOLO = MIOLO::getInstance();
        $module = $MIOLO->getCurrentModule();

        parent::__construct(_M('Resquisio de histricos', $module), null, null);

        // Desabilita todos os botes da MToolbar
        $this->toolbar->disableButton(MToolBar::BUTTON_NEW);
        $this->toolbar->disableButton(MToolBar::BUTTON_DELETE);
        $this->toolbar->disableButton(MToolBar::BUTTON_SAVE);
        $this->toolbar->disableButton(MToolBar::BUTTON_SEARCH);
        $this->toolbar->disableButton(MToolBar::BUTTON_PRINT);
    }

    public function defineFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = $MIOLO->getCurrentModule();
        
        // Instancia os bussines
        $busPerson = new BusinessBasicBusPerson();
        $busFrequencyAndNotes = new BusinessServicesBusFrequencyAndNotes();

        // Pega os dados do aluno logado
        $this->personData = $busPerson->getPersonByMioloUserName(trim($MIOLO->getLogin()->id));
        
        // Busca os dados na base
        $filters = new stdClass();
        $filters->conveniada = $this->personData->personId;
//        $filters->conveniada = 6114;
//        flog($filters);
        //lookup pessoa
        $fields[] = new SLookupContainer('personId', $this->getRequestValue('personId'), array(
            'label' => _M('Pessoa', $module),
            'item' => 'PhysicalPersonStudent',
            'module' => 'basic',
            'hint' => _M('Pessoa que ser inscrita processo seletivo selecionado (caso exista)', $module),
        ));

        //Field unit
        $business = new BusinessBasicBusUnit();
        $opts     = $business->listUnit();
        $unitIdS  = new MComboBox('unitIdS', $this->getFormValue('unitIdS', $data->unitIdS), _M('Unidade', $module), $opts);
        $unitIdS->setJsHint(_M('Selecione uma unidade', $module));
        $fields[] = $unitIdS;
        
        /**
        * Periodo
        */
        //Field beginDate
        $beginDateLabel = new MLabel(_M('De', $module) . ':');
        $beginDateLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
        $beginDate = new MCalendarField('beginDate', $this->getFormValue('beginDate', $data->beginDate), null, SAGU::getParameter('BASIC', 'FIELD_DATE_SIZE'));
        $beginDate->setJsHint(_M('Informe a data de incio do perodo de estgio',$module));
        $dateStage[] = new MHContainer('beginDateCnt', array( $beginDateLabel, $beginDate ));
        //Field endDate
        $endDateLabel = new MLabel(_M('At', $module) . ':');
        $endDateLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
        $endDate = new MCalendarField('endDate', $this->getFormValue('endDate', $data->endDate), null, SAGU::getParameter('BASIC', 'FIELD_DATE_SIZE'));
        $endDate->setJsHint(_M('Informe a data de fim do perodo de estgio',$module));
        $dateStage[] = new MHContainer('endDateCnt', array( $endDateLabel, $endDate ));
        //container
        $fields[] = new MBaseGroup('bsgPeriod', _M('Perodo',$module), $dateStage, 'vertical');

        
        
        // Botoes de filtro
        $fields[] = new MButton('generate', 'Filtros');
        
        $fields[] = new MSeparator();
//        $fields[] = SAGU::getRequiredLegend();
        $fields[] = new MSeparator();

        
        // Monta um array com os dados da grid
        $personId = $this->getFormValue('personId');
        $unitId = $this->getFormValue('unitIdS');
        $beginDateValue = $this->getFormValue('beginDate');
        $endDateValue = $this->getFormValue('endDate');
        
        
        if ( strlen($personId) > 0 ||  strlen($unitId) > 0 || strlen($beginDateValue) > 0 || strlen($endDateValue) > 0)
        {
//            $filters = new stdClass();
            $filters->personid = $personId;
            $filters->unitid = $unitId;
            $filters->beginDate = $beginDateValue;
            $filters->endDate = $endDateValue;
            
            $gridData = TraRequest::searchTrainingHistory($filters);

            // Grid training history
            $fields[] = $grdResults = $MIOLO->getUI()->getGrid($module, 'GrdRequestHistory', $filters);
            $grdResults->setData($gridData);
        }
        else
        {
            $filters = new stdClass();
            $filters->showall = true;
            
            $gridData = TraRequest::searchHistory($filters);

            // Grid training history
            $fields[] = $grdResults = $MIOLO->getUI()->getGrid($module, 'GrdRequestHistory', $filters);
            $grdResults->setData($gridData);
        }
        
        // Div onde aparecer as provas
//        $fields[] = new MDiv('divPopupViewEvaluations');
        
        parent::defineFields(array('fields' => $fields));
    }
}
?>