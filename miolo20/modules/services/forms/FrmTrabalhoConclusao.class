<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Formulrio para consultar as residncias feitas pelo aluno
 *
 * @author Jonas Gualberto Diel [jonas_diel@solis.coop.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Jonas Gualberto Diel [jonas_diel@solis.coop.br]
 * Fabiano Tomasini [fabiano@solis.coop.br]
 *
 * @since
 * Class created on 21/07/2011
 */
class FrmTrabalhoConclusao extends SForm
{
    /*
     * Armazena os dados da pessoa (do aluno logado)
     */
    public $personData;
    
    /*
     * Verifica de qual residncia o usurio  oriundo.
     */
    private $tipoResidencia;

    /**
     * Class constructor
     */
    public function __construct()
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
       
        //Seta o tipo de residencia
        strpos($MIOLO->getCurrentAction(), 'residency') > 0 ? $this->tipoResidencia = 'residency' : $this->tipoResidencia = 'resmedica';

        parent::__construct(_M('Consulta do Residente', $module), null, null);

        //Acessado pelo mdulo de servios
        if ( SAGU::userIsFromServices() )
        {
            // Desabilita a Toolbar
            $this->disableToolbar();
        }
        else
        {
            // Desabilita alguns botes da toolbar
            $this->toolbar->disableButton(MToolBar::BUTTON_NEW);
            $this->toolbar->disableButton(MToolBar::BUTTON_SAVE);
            $this->toolbar->disableButton(MToolBar::BUTTON_SEARCH);
            $this->toolbar->disableButton(MToolBar::BUTTON_DELETE);
            $this->toolbar->disableButton(MToolBar::BUTTON_PRINT);
        }
    }

    /**
     * Default method to define fields
     */
    public function defineFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        //Setando o type certo
        $this->tipoResidencia == 'residency' ? $typeResidente = new ResResidente() : $typeResidente = new MedResidente();
        
        try
        {
            //Acessado pelo mdulo de servios
            if ( SAGU::userIsFromServices() )
            {
                // Instancia os bussines
                $busPerson = new BusinessBasicBusPerson();
                // Pega os dados do aluno logado
                $personData = $busPerson->getPersonByMioloUserName(trim($MIOLO->getLogin()->id));
                // Verifica se no encontrou uma pessoa
                if ( !is_object($personData) )
                {
                    throw new Exception(_M('O usurio logado no est relacionado a uma pessoa', $module) . '.');
                }

                $residenteId = $typeResidente::obterResidenteIdAtivo($personData->personId);
                
                $residente = new $typeResidente($residenteId);

                if ( !strlen($residenteId) > 0 )
                {
                    throw new Exception(_M('Voc no possui nenhuma residncia ativa', $module) . '.');
                }
              
            }
        }
        catch ( Exception $e )
        {
            $MIOLO->error($e->getMessage());
        }

        $fields[] = new MDiv('divPopup', null);

        //Acessado pelo mdulo de servios
        if ( SAGU::userIsFromServices() )
        {
            $fields = array();

            if ($this->tipoResidencia != 'residency') {
                $fields[] = $enfaseId =  new MSelection('modalidadeId', $this->GetFormValue('modalidadeId', $residente->trabalhoDeConclusao->modalidadeId), _M('Modalidade'), MedTrabalhoDeConclusaoModalidade::listModalidades());
                $validators[] = new MRequiredValidator('modalidadeId', _M('Modalidade', $module));
            }


            // titulo
            $fields[] = new MTextField('titulo', $residente->trabalhoDeConclusao->titulo, _M('Ttulo'), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_SIZE'));
            $validators[] = new MRequiredValidator('titulo', _M('Titulo', $module));
            // tema
            $fields[] = new sMultiLineField('tema', array(
                'label' => _M('Tema'),
                'value' => $residente->trabalhoDeConclusao->tema,
                'rows'  => 8,
                'cols'  => 80
            ));

            // gera array com coorientadores
            $coorientadores = array();

            foreach ( (array) $residente->trabalhoDeConclusao->coorientadores as $coorientador )
            {
                $coorientadores[] = trim($coorientador->personIdDescription);
            }
            
            // gera array com membros banca
            $banca = array();
            
            foreach ( (array) $residente->trabalhoDeConclusao->membroDaBanca as $membro )
            {
                $banca[] = trim($membro->_personIdDescription);
            }
            //orientador
            $basPerson = new BusinessBasicBusPhysicalPerson();
            $orientador = $basPerson->getPerson($residente->trabalhoDeConclusao->orientadorId);
            
            $fields[] = new MTextLabel('lblO', SAGU::NVL($orientador->name, ' No informado '), _M('Orientador'));
            $fields[] = new MTextLabel('lblC', SAGU::NVL(implode(', ', $coorientadores), ' No informado '), _M('Coorientadores'));
            $fields[] = new MTextLabel('lblB', SAGU::NVL(implode(', ', $banca), ' No informado '), _M('Banca examinadora'));
            
            $btnSave = new MButton('btnSalvarTcc', _M('Salvar'));
            $btnBack = new MButton('btnBack', _M('Voltar', $module), $MIOLO->GetActionURL('services', "main:{$this->tipoResidencia}"));
            $fields[] = new MSeparator();
            $fields[] = new MDiv('hctSalvarTcc', array($btnSave,$btnBack));           
        }
        //Boto voltar
        $this->SetValidators($validators);
        $this->SetFields($fields);
        parent::defineFields();
    }

    public function btnSalvarTcc_click($sender=null)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        
        //Setando o type certo
        $this->tipoResidencia == 'residency' ? $typeResidente = new ResResidente() : $typeResidente = new MedResidente();
        $this->tipoResidencia == 'residency' ? $typeTCC = new ResTrabalhoDeConclusao() : $typeTCC = new MedTrabalhoDeConclusao();
        
        $mioloUserName = trim($MIOLO->getLogin()->id);
        $busPerson = new BusinessBasicBusPerson();
        $personData = $busPerson->getPersonByMioloUserName($mioloUserName);
        
        $residenteId = $typeResidente::obterResidenteIdAtivo($personData->personId);
        $titulo = MIOLO::_REQUEST('titulo');
        $tema = MIOLO::_REQUEST('tema');
        $modalidadeId = MIOLO::_REQUEST('modalidadeId');
        
        $residente = new $typeResidente($residenteId);
        $trabalho = $residente->trabalhoDeConclusao;
        
        try
        {
            if ( strlen($titulo) == 0 )
            {
                throw new Exception(_M('O campo "Ttulo" deve ser informado'));
            }
            
            // prepara type para quando for modo inserir novo
            if ( ! ( $trabalho instanceof $typeTCC ) )
            {
                $trabalho = new $typeTCC();
                $trabalho->residenteId = $residenteId;
            }
            
            // salva os dados
            $trabalho->titulo = $titulo;
            $trabalho->tema = $tema;

            if ($this->tipoResidencia != 'residency') {
                $trabalho->modalidadeId = $modalidadeId;
            }
            $trabalho->save();
            
            SAGU::information(_M('Dados salvos com sucesso.', $module), $this->getPreviousURL());

            $url = $MIOLO->GetActionURL(MIOLO::getCurrentModule(), MIOLO::getCurrentAction(), null, array('residenteId' => $residenteId));
            $MIOLO->page->redirect($url);
        }
        catch (Exception $ex)
        {
            $this->AddError($ex->getMessage());
        }
    }
}
?>