<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 * 
 * Este arquivo  parte do programa Sagu.
 * 
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 * 
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 * 
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 * 
 *
 * This file manipulate the lookups for the basic module of sagu
 *
 * @author Moises Heberle [moises@solis.coop.br]
 *
 * $version: $Id$
 *
 * \b Maintainers \n
 * Moises Heberle [moises@solis.coop.br]
 *
 * @since
 * Class created on 15/06/2011
 *
 **/
class BusinessHumanResourcesLookup
{
    public function autoCompleteScheduledActivity(&$context)
    {
        $module = 'basic';

        $sql = 'SELECT A.description
              FROM hur.scheduledActivity A
             WHERE A.scheduledActivityId = ?';

        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }


    public function lookupScheduledActivity(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_REQUEST('lmodule');

        $scheduledActivityId = $lookup->getFilterValue('scheduledActivityId');
        $description = $lookup->getFilterValue('description');
        $activityTypeId = $lookup->getFilterValue('activityTypeId');
        $startDate = $lookup->getFilterValue('startDate');
        $endDate = $lookup->getFilterValue('endDate');

        $lookup->addFilterField( new MTextField('scheduledActivityId', $scheduledActivityId, _M('Cdigo', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE')) );
        $lookup->addFilterField( new MTextField('description', $description, _M('Descrio', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE')) );
        $lookup->addFilterField( new MSelection('activityTypeId', $activityTypeId, _M('Tipo de atividade', $module), HurActivityType::listRecords()) );
        $lookup->addFilterField( new MCalendarField('startDate', $startDate, _M('Data inicial', $module), SAGU::getParameter('BASIC', 'FIELD_DATE_LOOKUP_SIZE')) );
        $lookup->addFilterField( new MCalendarField('endDate', $endDate, _M('Data final', $module), SAGU::getParameter('BASIC', 'FIELD_DATE_LOOKUP_SIZE')) );

        $MIOLO->page->onLoad( "document.{$MIOLO->page->name}.description.focus()" );

        $columns = array(
            new DataGridColumn('scheduleActivityId', _M('Cdigo', $module), 'right', true, null, true),
            new DataGridColumn('description', _M('Descrio', $module), 'left', true, null, true),
            new DataGridColumn('activityType', _M('Tipo de atividade', $module), 'left', true, null, true),
            new DataGridColumn('startDate', _M('Data inicial', $module), 'left', true, null, true),
            new DataGridColumn('endDate', _M('Data final', $module), 'left', true, null, true),
            new DataGridColumn('isInternal', _M('Interno', $module), 'center', true, null, true, SAGU::listYesNo()),
        );

        $maskTimestamp = SAGU::getParameter('BASIC', 'MASK_DATE') . ' ' . SAGU::getParameter('BASIC', 'MASK_TIME');
        $sql = sprintf("SELECT A.scheduledActivityId AS scheduleActivityId,
                           A.description AS description,
                           TO_CHAR(A.startDate, '%s') AS startDate,
                           TO_CHAR(A.endDate, '%s') AS endDate,
                           B.description AS activityType,
                           A.isinternal AS isInternal
                      FROM hur.scheduledActivity A
                INNER JOIN hur.activityType B
                        ON (A.activityTypeId = B.activityTypeId)", $maskTimestamp, $maskTimestamp);

        if ( strlen($scheduledActivityId) > 0 )
        {
            $where .= ' AND A.scheduledActivityId = ?';
            $args[] = $scheduledActivityId;
        }

        if ( strlen($activityTypeId) > 0 )
        {
            $where .= ' AND A.activityTypeId = ?';
            $args[] = $activityTypeId;
        }

        if ( strlen($startDate) > 0 )
        {
            $where .= " AND A.startDate::date = TO_TIMESTAMP(?, '{$maskTimestamp}')::date";
            $args[] = $startDate;
        }

        if ( strlen($endDate) > 0 )
        {
            $where .= " AND A.endDate::date = TO_TIMESTAMP(?, '{$maskTimestamp}')::date";
            $args[] = $endDate;
        }

        if ( strlen($description) > 0 )
        {
            $where .= ' AND A.description ILIKE ?';
            $args[] = $description . '%';
        }

        if ( strlen($where) > 0 )
        {
            $sql .= ' WHERE ' . substr($where, 5);
        }

        $sql .= ' ORDER BY A.scheduledActivityId';

        $sqlObject = new sql();
        if ( strlen($where) == 0 )
        {
            $sql .= ' LIMIT 0';
        }

        $sqlObject->createFrom(SAGU::prepare($sql, $args));
        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Pesquisar atividade programada', $module), 15, 0);
        $lookup->grid->setIsScrollable();
    }
}
?>