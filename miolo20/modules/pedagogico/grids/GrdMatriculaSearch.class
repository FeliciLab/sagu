<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Inscricoes
 *
 * @author Jonas Gualberto Diel [jonas_diel@solis.com.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Jonas Gualberto Diel [jonas_diel@solis.com.br]
 * Moises Heberle [moises@solis.com.br]
 *
 * @since
 * Class Created on 30/08/2013
 *
 **/
class GrdMatriculaSearch extends SGrid
{
    public function __construct($filters)
    {
        $MIOLO = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();

        $columns = array(
            'inscricao.personid' => new MGridColumn( _M('Cdigo da pessoa', $module), 'left', false, 0, false),
            'inscricao.inscricaoid' => new MGridColumn( _M('Inscrio', $module), 'right'),
            '_pessoa' => new MGridColumn( _M('Pessoa', $module)),
            'ofertaturma.descricao' => new MGridColumn( _M('Turma', $module), 'left'),
            '_nomecurso' => new MGridColumn( _M('Oferta de Curso (Curso)', $module)),
            'acpmatricula.situacao' => new MGridColumn( _M('Situao', $module), 'left', false, 0, true),
            'acpmatricula.datamatricula' => new MGridColumn( _M('Data matrcula', $module), 'center'),
            'curso.gratuito' => new MGridColumn( _M('Curso gratuito', $module), 'left', false, 0, false),
        );

        parent::__construct($filters, $columns, __CLASS__, array('inscricaoid' => '%inscricao.inscricaoid%'));

        $columns['ofertaturmadesc']->order->true;
        $this->setPageLength(200);
        $this->clearActions();

        $this->setRowMethod('GrdMatriculaSearch', 'myRowMethod');
        
        $acaoConvenio = $MIOLO->GetActionURL('finance', 'register:convenantPerson', '', array('personIdS' => '%inscricao.personid%'));
        $iconVerConvenio = new MGridActionIcon($this, 'financialSituation-16x16.png', $acaoConvenio, _M('Ver convnios', $module));
        $iconVerConvenio->setTarget('_blank');
        $this->actions[] = $iconVerConvenio;
        $acaoConfirmar = $MIOLO->GetActionURL($module, 'main:process:confirmacaomatricula', '', array('inscricaoid' => '%inscricao.inscricaoid%', 'function' => 'update'));
        $this->addActionIcon(_M('Confirmar', $module), 'realized.png', $acaoConfirmar);
        $acaoCancelar = $MIOLO->GetActionURL($module, 'main:process:matricula', '', array('inscricaoid' => '%inscricao.inscricaoid%', 'event' => 'cancelaMatricula', 'buscaofertaturmaidS' => $filters->buscaofertaturmaid, 'buscaocorrenciacursoidS' =>$filters->buscaocorrenciacursoid, 'buscaofertacursoidS' => $filters->buscaofertacursoid,
        'situacaoMatriculaS' => $filters->situacaoMatricula, 'buscanomeS' => $filters->buscanome));
        $this->addActionIcon(_M('Cancelar', $module), 'toolbar-delete.png', $acaoCancelar);
    }
    
    public function myRowMethod($i, $row, $actions, $columns )
    {
        $MIOLO = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();

        if( $row['curso.gratuito'] == DB_TRUE )
        {
            $args = array('inscricaoid' => '%inscricao.inscricaoid%', 'function' => 'update', 'event' => 'btnConfirm_click');
        }
        else
        {
            $args = array('inscricaoid' => '%inscricao.inscricaoid%', 'function' => 'update');
        }
        $acaoConfirmar = $MIOLO->GetActionURL($module, 'main:process:confirmacaomatricula', '', $args);
        
        $actions[1]->enable();
        $actions[1]->alt = _M('Confirmar matrcula');
        $actions[1]->href = $acaoConfirmar;
        $actions[2]->enable();
        $actions[2]->alt = _M('Cancelar matrcula');
        
        $situacaoInscricao = AcpInscricao::listarSituacao();
        if( $row['acpmatricula.situacao'] != $situacaoInscricao[AcpInscricao::SITUACAO_PENDENTE])
        {
            $actions[1]->disable();
            $actions[1]->alt = _M('Matricula confirmada');
        }
        if( $row['acpmatricula.situacao'] == AcpMatricula::SITUACAO_CANCELAMENTO )
        {
            $actions[2]->disable();
            $actions[2]->alt = _M('Matricula cancelada');
            $actions[1]->disable();
            $actions[1]->alt = _M('Matricula cancelada');
        }
    }
}
?>