<?php

$MIOLO->uses('classes/sreport.class', 'basic');

class FrmAttachedLeaf extends SForm
{
    
    public function __construct($data)
    {
        $module = MIOLO::getCurrentModule();
        parent::__construct( _M('Dirio de classe', $module), NULL, NULL );
    }

    /**
     * Default method to define fields
     */
    public function defineFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $action = MIOLO::getCurrentAction();

        $data = $this->getTypesData();
        
        $fields[] = new MHiddenField('emissionDate');
        $fields[] = $groupId = new MLookupContainer('groupId', 'groupDescription', '', _M('Disciplina oferecida'), array('null,null,null,null,null,null,groupDescription'), $module, 'Group', '', TRUE, 10);
        $groupId->setReadOnly(TRUE);
        $fields[] = new Separator('');
        
        // Perodo
        $fields[] = new MCalendarField('beginDate', NULL, _M('Perodo de'));
        $fields[] = new MCalendarField('endDate', NULL, _M('at'));
        

        // Field rad option file type
        $opts = array('pdf' => _M('Arquivo PDF (no editvel)'));
        $fields[] = new MSelection('generateOption', 'pdf', _M('Formato'), $opts);
        

        $fields[] = new Separator('');
        $btnGerar = new MButton('btnGerar', _M('Gerar dirio de classe', $module));
        $fields[] = $btnGerar;
        $fields[] = new Separator('');
        
        $validators[] = new MRequiredValidator('groupId');
        $validators[] = new MRequiredValidator('generateOption');
        $validators[] = new MDATEDMYValidator('beginDate');
        $validators[] = new MDATEDMYValidator('endDate');
        
        parent::defineFields( array( 'fields' => $fields, 'validators' => $validators ) );

        $this->toolbar->disableButton(MToolBar::BUTTON_NEW);
        $this->toolbar->disableButton(MToolBar::BUTTON_SEARCH);
        $this->toolbar->disableButton(MToolBar::BUTTON_DELETE);
        $this->toolbar->disableButton(MToolBar::BUTTON_PRINT);
        $this->toolbar->disableButton(MToolBar::BUTTON_SAVE);
    }
    
    public function btnGerar_click()
    {
        $data = $this->getData();
        
        $options['module'] = $module = SAGU::getFileModule(__FILE__);
        $options['reportName'] = 'attachedLeaf';
        
        if ( strlen($data->groupId) > 0 )
        {
            $options['parameters']['groupid'] = (int) $data->groupId;
        }
        $options['parameters']['lines'] = SAGU::getParameter('basic', 'ATTACHED_LEAF_LINES');
        $options['parameters']['beginDate'] = $data->beginDate;
        $options['parameters']['endDate'] = $data->endDate;
        
        $options['fileType'] = $data->generateOption;

        $sreport = new SReport($options);

        if ( !$sreport->generate() )
        {
            $this->addError(_M('No foi possvel gerar o documento. Verifique se o professor e o horrio da disciplina esto definidos.', $module ));
        }
    }
    
    public function getTypesData()
    {
        $data->groupId = $this->groupId->value;
        $data->periodId = $this->periodId->value;
        $data->courseId = $this->courseId->value;
        $data->courseVersion = $this->courseVersion->value;
        $data->emissionDate = $this->emissionDate->value;
        $data->generateOption = $this->generateOption->value;

        return $data;
    }
    
}
?>