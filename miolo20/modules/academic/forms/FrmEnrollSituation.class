<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Soluções Livres Ltda.
 *
 * Este arquivo é parte do programa Sagu.
 *
 * O Sagu é um software livre; você pode redistribuí-lo e/ou modificá-lo
 * dentro dos termos da Licença Pública Geral GNU como publicada pela Fundação
 * do Software Livre (FSF); na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO
 * ou APLICAÇÃO EM PARTICULAR. Veja a Licença Pública Geral GNU/GPL em
 * português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título
 * "LICENCA.txt", junto com este programa, se não, acesse o Portal do Software
 * Público Brasileiro no endereço www.softwarepublico.gov.br ou escreva para a
 * Fundação do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Form to choice the enroll book report option
 *
 * @author Leovan Tavares da Silva [leovan@solis.coop.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Armando Taffarel Neto [taffarel@solis.coop.br]
 * Arthur Lehdermann [arthur@solis.coop.br]
 * Daniel Afonso Heisler [daniel@solis.coop.br]
 * Jamiel Spezia [jamiel@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 *
 * @since
 * Class created on 02/08/2006
 */

/**
 * Form to generate Multiple Learning Period
 */
class FrmEnrollSituation extends SForm
{
    private $home;
    public $filters;

    /**
     * Class constructor
     */
    public function __construct($data)
    {
        $module = MIOLO::getCurrentModule();
        $this->home   = $data->home;

        parent::__construct( _M('Situação da matrícula', $module), NULL, NULL );
    }

    /**
     * Default method to define fields
     */
    public function defineFields()
    {
        $MIOLO    = MIOLO::getInstance();
        $module   = MIOLO::getCurrentModule();
        $action   = MIOLO::getCurrentAction();
        $periodId = MIOLO::_request('periodId');
        
        $fields[] = new MSeparator('');

        $dperiodId      = strlen($this->getFormValue('periodId', $data->periodId))>0 ? $this->getFormValue('periodId', $data->periodId) : SAGU::getParameter('BASIC', 'CURRENT_PERIOD_ID');
        $businessPeriod = new BusinessAcademicBusPeriod();
        $periodId       = new MComboBox('periodId', $dperiodId, _M('Período',$module), $businessPeriod->listPeriod() );
        $validators[]   = new MRequiredValidator('periodId');
        $fields[]      = $periodId;

        /*
         * Course occurrence lookup
         */
        $lkpValue = array(
            $this->GetFormValue('courseId', $data->courseId),
            $this->GetFormValue('courseVersion', $data->courseVersion),
            $this->GetFormValue('turnId', $data->turnId),
            $this->GetFormValue('unitId', $data->unitId)
        );
        $courseOccurrenceLookup = new SCourseOccurrenceLookup($lkpValue);
        $courseOccurrenceLookup->showRequiredLabel();
        $validators[] = new MRequiredValidator('courseId', _M('Curso', $module));
        $validators[] = new MIntegerValidator('courseVersion', _M('Versão do curso', $module));
        $validators[] = new MIntegerValidator('turnId', _M('Turno', $module));
        $validators[] = new MIntegerValidator('unitId', _M('Unidade', $module));
        $fields[] = $courseOccurrenceLookup;

        $busEnrollStatus = new BusinessAcademicBusEnrollStatus();
        $statusId        = new MComboBox('statusId', $this->getFormValue('statusId', $data->statusId), _M('Estado', $module), $busEnrollStatus->listEnrollStatus());
        $validators[]    = new MRequiredValidator('statusId');
        $fields[]        = $statusId;

        $reportOptions  = array(    array(_M('Considerar apenas matrículas NO período selecionado', $module), 1),
                                    array(_M('Considerar matrículas ATÉ o período selecionado', $module), 2),
                                    array(_M('Lista total (inclusive inativos)', $module), 3)
                                );
        $reportLabel    = new MText('reportLabel', _M('Opção de relatório', $module) . ':');
        $reportLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
        $reportLabel->setClass('m-caption m-caption-required');
        $reportOption   = new MRadioButtonGroup('reportOption', '', $reportOptions, $this->getFormValue('reportOption', 1));
        $reportOption->setShowLabel(false);
        $hctReportOpt   = new MHContainer('hctReportOpt', array($reportLabel, $reportOption));
        $hctReportOpt->setShowLabel(false);
        $fields[]      = $hctReportOpt;

        $btn1     = new MButton('btnList', _M('Lista', $module));
        $fields[] = $btn1;
        $fields[] = new MSeparator('<hr>');
        
        parent::defineFields( array('fields' => $fields, 'validators' => $validators ) );

        $this->toolbar->disableButton(MToolBar::BUTTON_NEW);
        $this->toolbar->disableButton(MToolBar::BUTTON_DELETE);
        $this->toolbar->disableButton(MToolBar::BUTTON_PRINT);
        $this->toolbar->disableButton(MToolBar::BUTTON_SAVE);
        $this->toolbar->disableButton(MToolBar::BUTTON_SEARCH);
    }

    /**
     * Event triggered when user clicks list button
     */
    public function btnList_click($sender=NULL)
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $action = MIOLO::getCurrentAction();

        $business = new BusinessAcademicBusEnrollSituation();
        $data     = $this->getData();

        $listData = $business->listPupilsByEnrollSituation($data);

        $title    = _M('Alunos por situação de matrícula', $module);

        $grdResults = $MIOLO->getUI()->getGrid($module,'GrdEnrollSituation',$filters);
        $grdResults->setData($listData);
        $grdResults->setTitle($title);
        $this->addField($grdResults);
    }
}
?>