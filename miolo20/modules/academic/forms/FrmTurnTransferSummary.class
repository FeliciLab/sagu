<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Formulrio responsvel pelos dados contratuais da transferencia de turno
 *
 * @author Moises Heberle [moises@solis.coop.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Moises Heberle [moises@solis.coop.br]
 *
 * @since
 * Class created on 02/09/2011
 *
 **/
class FrmTurnTransferSummary extends FrmTurnTransfer
{
    public function __construct($steps = null)
    {
        parent::__construct($steps, __CLASS__);
    }

    public function createFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $action = MIOLO::getCurrentAction();
        $function = MIOLO::_REQUEST('function');

        $busCourseOccurrence = new BusinessAcademicBusCourseOccurrence();
        $busContract = new BusinessAcademicBusContract();
        $busCurriculum = new BusinessAcademicBusCurriculum();
        $busEnroll = new BusinessAcademicBusEnroll();
        $busMovementContract = new BusinessAcademicBusMovementContract();
        $busPhysicalPerson = new BusinessBasicBusPhysicalPerson();
        $busTurn = new BusinessBasicBusTurn();
        $busUnit = new BusinessBasicBusUnit();
        $busCourse = new BusinessAcademicBusCourse();

        //Load data
        $stepData = $this->getStepData();


        $contract = $busContract->getContract($stepData->contractId);
        $person = $busPhysicalPerson->getPhysicalPerson($contract->personId);

        // BaseGroup info 1
        $options = array(
            _M('Pessoa', $module) => $person->name,
            _M('Contrato', $module) => $contract->contractId,
            _M('Curso', $module) => $contract->courseId . '/' . $contract->courseVersion . ' - ' . $busCourse->getCourse($contract->courseId)->name,
            _M('Turno', $module) => $stepData->oldTurnId . ' - ' . $busTurn->getTurn($stepData->oldTurnId)->description,
            _M('Unidade', $module) => $stepData->_unitId . ' - ' . $busUnit->getUnit($stepData->_unitId)->description,
        );
        $info = new sBaseGroup(rand(), _M('Contrato de origem', $module), $this->createBgrFields($options));
        $info->setWidth('48.5%');

        // BaseGroup info 2
        $options = array(
            '' => '',
            '' => '',
            _M('Turno', $module) => $MIOLO->session->getValue("old_turnId") . ' - ' . $busTurn->getTurn($MIOLO->session->getValue("old_turnId"))->description,
            ' ' => ' ',
            ' ' => ' ',
        );
        $info2 = new sBaseGroup(rand(), _M('Turno de destino', $module), $this->createBgrFields($options));
        $info2->setWidth('48.5%');

        //
        $fields[] = $hct = new MHContainer(rand(), array($info, $info2));

        // BaseGroup Modificaes nas disciplinas
        $fields[] = new MSeparator();
        $controls = array();
        $tableData = $MIOLO->session->get('tableModificacoesDisciplinas'); // Construido no passo anterior FrmTurnTransferContractualData
        $fields[] = $table = new MTableRaw(_M('Modificaes nas disciplinas', $module), $tableData, array(
            _M('Perodo', $module),
            _M('Disciplina', $module),
            _M('C.H.', $module),
            _M('Status atual', $module),
            _M('Situao', $module),
        ));

        // BaseGroup Ttulos que sero transferidos
        $tableData = $MIOLO->session->get('tableTitulosTransferir'); // Construido no passo anterior FrmTurnTransferContractualData
        if ( count($tableData) > 0 )
        {
            $fields[] = new MSeparator();
            $controls = array();
            $fields[] = $table = new MTableRaw(_M('Ttulos que sero transferidos', $module), $tableData, array(
                _M('Ttulo', $module),
                _M('Vencimento', $module),
                _M('Valor', $module),
            ));
        }

        $this->setFields($fields);
    }

    
    /**
     *
     * @param array $options
     * @return MHContainer
     */
    private function createBgrFields($options)
    {
        $bgrFields = array();
        foreach ( $options as $label => $value )
        {
            $lbl = new MText('lbl' . rand(), $label . (strlen(trim($label)) > 0 ? ':' : null));
            $lbl->setWidth( SAGU::getParameter('BASIC', 'FIELD_LABEL_SIZE') );
            $val = new MText('txt' . rand(), $value);
            $val->setBold(true);
            $bgrFields[] = new MHContainer('hct' . rand(), array($lbl, $val));
        }

        return $bgrFields;
    }

    public function finalizeButton_click($args)
    {
        $this->executeProcess( $args, true);
        
        parent::finalizeButton_click($args);
    }
}
?>