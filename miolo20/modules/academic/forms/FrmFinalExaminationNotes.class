<?php

/**
 * <--- Copyright 2005-2014 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Passo responsavel pela selecao dos componentes da banca examinadora.
 *
 * @author Lus Felipe Wermann [luis_felipe@solis.com.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Moises Heberle [moises@solis.coop.br]
 * Lus Felipe Wermann [luis_felipe@solis.com.br]
 *
 * @since
 * Class created on 29/08/2014
 *
 * */
class FrmFinalExaminationNotes extends FrmFinalExamination {

    public function __construct($steps = null)
    {
        parent::__construct(null, $steps, __CLASS__);
    }

    public function createFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $action = MIOLO::getCurrentAction();
        $function = MIOLO::_REQUEST('function') ;

        //Load data
        $allData = $this->getStepData();
        $stepData = $this->getStepDataByForm(__CLASS__);

        $sub = MSubDetail::getData('examiningBoard');
        $filters = new StdClass();
        $filters->enrollId = MIOLO::_REQUEST('enrollId');
        
        $busEnroll = new BusinessAcademicBusEnroll();
        $enroll = $busEnroll->getEnroll($filters->enrollId);

        $busGroup = new BusinessAcademicBusGroup();
        $group = $busGroup->getGroup($enroll->groupId);
        $conceitos = BusinessAcademicBusConcept::listConceptByGroup($group->conceptGroupId);
            
        $learningPeriodId = $group->learningPeriodId;

        $busFinalExaminationBoard = new BusinessAcademicBusFinalExaminationExaminingBoard();
        $finalNote = $busFinalExaminationBoard->getValorNotaFinal($filters->enrollId, $learningPeriodId);

        //Nota dos examinadores
        $listExaminators = array();
        
        foreach ($sub as $row => $val)
        {
            if (!$val->removeData)
            {
                //criar label
                $person = $val->personId . ' - ' . $val->personName;
                $teachersLabel = new MLabel(_M($person, $module), $module);
                $teachersLabel->setWidth(300);
                $teachersLabel->setClass('m-caption');

                //verificar se j existem notas cadastradas
                $filters = new stdClass();
                $filters->personId = $val->personId;
                $filters->enrollId = strlen($val->enrollId) > 0 ? $val->enrollId : MIOLO::_REQUEST('enrollId');
                $nomeCampo = 'note_' . $val->personId;
                $noteExaminator = $busFinalExaminationBoard->searchFinalExaminationExaminingBoard($filters, true);
                
                if ( $group->useConcept == DB_TRUE )
                {
                    $teachersField = new MSelection($nomeCampo, strlen($allData->{$nomeCampo}) > 0 ? $allData->{$nomeCampo} : $noteExaminator[0]->note, null, $conceitos);
                }
                else
                {
                    //primeiro busca nota do allData, depois o que veio do banco e em ultimo seta zero
                    if (strlen($allData->{$nomeCampo}) > 0)
                    {
                        $teachersField = new MTextField($nomeCampo, $allData->{$nomeCampo}, null, SAGU::getParameter('BASIC', 'FIELD_ID_SIZE'));
                    }
                    else if (strlen($noteExaminator[0]->note) > 0)
                    {
                        $teachersField = new MTextField($nomeCampo, $noteExaminator[0]->note, null, SAGU::getParameter('BASIC', 'FIELD_ID_SIZE'));
                    }
                    else
                    {
                        $teachersField = new MTextField($nomeCampo, '0', null, SAGU::getParameter('BASIC', 'FIELD_ID_SIZE'));
                    }
                }

                $htcExaminators = new MHContainer('htcExaminators', array($teachersLabel, $teachersField));
                $listExaminators [] = $htcExaminators;
            }
        }

        $fieldsBaseGroup[] = new MVContainer('mvContainer', $listExaminators);

        $bsgNotesExam = new MBaseGroup('bsgNotesExam', _M('Nota dos examinadores', $module), $fieldsBaseGroup);
        $fields[] = $bsgNotesExam;

        //Nota final
        if ( $group->useConcept == DB_TRUE )
        {
            $label = _M('CONCEITO FINAL:', $module);
            $finalField = new MSelection('txfFinalNote', strlen($allData->txfFinalNote) > 0 ? $allData->txfFinalNote : $finalNote[2], null, $conceitos);
        }
        else
        {
            if (strlen($allData->txfFinalNote) > 0)
            {
                $finalField = new MTextField('txfFinalNote', $allData->txfFinalNote, null, SAGU::getParameter('BASIC', 'FIELD_ID_SIZE'));
            }
            else if (strlen($finalNote[0]) > 0)
            {
                $finalField = new MTextField('txfFinalNote', $finalNote[1], null, SAGU::getParameter('BASIC', 'FIELD_ID_SIZE'));
            }
            else
            {
                $finalField = new MTextField('txfFinalNote', null, null, SAGU::getParameter('BASIC', 'FIELD_ID_SIZE'));
            }
            
            $label = _M('NOTA FINAL:', $module);
        }

        $finalLabel = new MLabel($label);
        
        $htcFinalNote = new MHContainer('htcFinalNote', array($finalLabel, $finalField));

        $fields[] = new MBaseGroup('bsgFinalNote', _M('Nota final', $module), array($htcFinalNote));

        $this->setFields($fields);
        $this->setValidators($validators);
    }
    
//    public function previousStepButton_click($args = null)
//    {
//        $stepNumber = array_search(__CLASS__, $this->forms);
//        $stepData = $this->getStepData($stepNumber);
//        $stepData->teucampo = $_REQUEST['teucampo'];
//        
//        $this->setStepData($stepData, $stepNumber); 
//        
//        parent::previousStepButton_click($args);
//    }

}

?>