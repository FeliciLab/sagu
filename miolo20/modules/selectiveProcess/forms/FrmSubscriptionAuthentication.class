<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Formulario onde  informado as informacoes da pessoa.
 *
 * @author Fabiano Tomasini [fabiano@solis.coop.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Fabiano Tomasini [fabiano@solis.coop.br]
 *
 * @since
 * Class created on 03/01/2011
 */
class FrmSubscriptionAuthentication extends SStepByStepForm
{
    public function __construct($steps = null)
    {
        if (!isset($steps->disableConstruct))
        {
            parent::__construct(null, $steps, __CLASS__);
            $this->toolbar->disableButton(MToolBar::BUTTON_SAVE);
            
        }
    }

    public function createFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $action = MIOLO::getCurrentAction();
        $function = MIOLO::_request('function');

        // Load data
        $allData = $this->getStepData();
        $stepOne = $this->getStepData(1);
        $stepData = $this->getStepDataByForm(__CLASS__);
        
        $allData->selectiveProcessId = $stepOne->selectiveProcessId;

        // Instance of the selective process
        $sprSP = new SprSelectiveProcess($allData->selectiveProcessId);

        // Se o processo seletivo requer autenticao.
        if( $sprSP->requireAuthentication == DB_TRUE )
        {
            $uidLabel = new MLabel(_M('Login',$module).':');
            $uidLabel->setWidth( SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE') );
            $uid = new MTextField('uid',$MIOLO->login->iduser, null, 20);
            $bsgLoginFields[] = new MHContainer('hctLogin', array($uidLabel, $uid));
            $pwdLabel = new MLabel(_M('Senha',$module).':');
            $pwdLabel->setWidth( SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE') );
            $pwd = new PasswordField('pwd','',null,20);
            $bsgLoginFields[] = new MHContainer('hctPwd', array($pwdLabel, $pwd));
            $bsgLoginFields[] = new HiddenField('username',$this->auth->login->user, _M('Nome'), 40);
            $bsgLoginFields[] = new MLink('mail',_M('Email para contato:'), 'mailto:'.$this->manager->GetConf('theme.email'),$this->manager->GetConf('theme.email'));
            $bsgLoginFields[] = new HiddenField('tries', '');
            $bsgLoginFields[] = new MButton('forgottenPassword', _M('Esqueci minha senha',$module), "window.open(' " . $MIOLO->GetActionURL('admin','forgottenPassword')."')");
            $bsgLoginFields[] = new HiddenField('return_to', $return_to);

            $bsgLogin = new MBaseGroup('bsgLogin', _M('Usurio existente', $module), $bsgLoginFields, 'vertical' );
            $bsgLogin->setShowLabel(true);

            if( SAGU::getParameter('basic', 'ALLOW_PUBLIC_REGISTRATION') == 'YES' )
            {
                $bsgLogin->setWidth('48%');
                $btnRegister = new MButton('btnRegister', _M('Cadastre-se', $module),"window.open(' " . $MIOLO->GetActionURL('admin','login',null, array('event'=>'btnRegister_click'))."')");
                $bsgRegister = new MBaseGroup('bsgRegister', _M('Novo usurio', $module), array($btnRegister), 'vertical' );
                $bsgRegister->setShowLabel(false);
                $bsgRegister->setAttribute('align', 'center');
                $bsgRegister->setWidth('48%');
            }

            $ctnH = new MHContainer('cntFields', array($bsgLogin,$bsgRegister));
            $fields[] = $ctnH;
        }
        // Se o processo seletivo no requer autenticao.
        else if ( $sprSP->requireAuthentication == DB_FALSE )
        {
            $fields[] = new MSeparator();
            // Field date birth
            $dateBirthLabel = new MText('dateBirthLabel', _M('Data de nascimento',$module) . ':');
            $dateBirthLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
            $dateBirthLabel->setClass('m-caption m-caption-required');
            $dateBirth = new MCalendarField('dateBirth', $this->getFormValue('dateBirth',$allData->dateBirth), null, SAGU::getParameter('BASIC', 'FIELD_DATE_SIZE'));
            $dateBirth->addAttribute('autocomplete', 'off');
            $validators[] = new MDateDMYValidator('dateBirth',_M('Data de nascimento',$module));
            $validators[] = new MRequiredValidator('dateBirth', _M('Data de nascimento',$module));
            $dateBirth->setJsHint(_M('Informe a data de nascimento',$module));
            $fields[] = new MHContainer('hctDateBirth', array($dateBirthLabel, $dateBirth));

            // Field cpf
            $cpfLabel = new MText('cpfLabel', _M('CPF',$module) . ':');
            $cpfLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
            $cpfLabel->setClass('m-caption m-caption-required');
            $cpf = new MTextField('cpf', $this->getFormValue('cpf',$allData->cpf), NULL, SAGU::getParameter('BASIC', 'FIELD_MONETARY_SIZE'));
            $cpf->setJsHint(_M('Informe seu CPF',$module));
            $cpf->addAttribute('autocomplete', 'off');
            $validators[]  = new MCPFValidator('cpf', _M('CPF',$module), 'required');
            $hctCpf = new MHContainer('hctPerson', array($cpfLabel, $cpf));
            $hctCpf->setShowLabel(true);
            $fields[] = $hctCpf;
        }

        $this->setFields($fields);
        $this->setValidators($validators);
        //Seta a proxima com o numero da atual ja que quando o usurio j est logado esse passo no exite mais
        if ( $sprSP->requireAuthentication == DB_TRUE )
        {
            $this->nextStep = $this->getCurrentStep();
        }
    }

    public function nextStepButton_click($args = null)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        $allData = $this->getStepData();
        $data = $this->getData();
        $sprSP = new SprSelectiveProcess($allData->selectiveProcessId);

        try
        {
            if( $sprSP->requireAuthentication == DB_TRUE )
            {
                // Max login tryes
                $max_tries = 3;

                // autenticar usurio e obter dados do login
                $uid = $this->GetFormValue('uid');
                $pwd = $this->GetFormValue('pwd');

                $MIOLO->LogMessage('[LOGIN] Validating login information: ' . $uid);

               if ( !$MIOLO->auth->Authenticate($uid, $pwd) )
               {
                   $tries = $this->GetFormValue('tries');

                   if ( $tries >= $max_tries )
                   {
                      $MIOLO->Error('Erro na identificao do usurio!');
                   }
                   else
                   {
                      $err = 'Erro na identificao do usurio!' . ' - Restam ' . ( $max_tries - $tries ) .
                             ' ' . 'tentativa(s).';
                      $tries++;
                      $this->SetFormValue('tries',$tries);
                      $pwd = null;

                      if ( $err )
                      {
                          throw new Exception($err);
                      }
                   }
                }
            }
            parent::nextStepButton_click($args);

        }
        catch (Exception $e)
        {
            $this->AddError($e->getMessage());
            return;
        }
    }
}
?>