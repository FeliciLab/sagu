<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Verificador de documentos
 *
 * @author Moises Heberle [moises@solis.com.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Moises Heberle [moises@solis.com.br]
 *
 * @since
 * Class created on 15/08/2013
 */
class BasDocumentoGerado extends SType
{
    protected $_associations = array(
        'pessoa' => array(
            'mode' => 'one',
            'typeClass' => 'BasPessoa',
            'joinColumn' => 'personiddocumento',
            'joinOnly' => true,
        ),
    );
    
    public $documentogeradoid;
    public $codigoverificador;
    public $datageracao;
    public $usuario;
    public $nomedocumento;
    public $titulo;
    public $modulo;
    public $fileid;
    public $personiddocumento;
    public $numeroregistro;
    public $parametros;
    
    /**
     *
     * @var BasPessoa
     */
    public $pessoa;
    
    /**
     * @return BasDocumentoGerado
     */
    public function buscaPeloIdentificador($codVerificador, $numeroRegistro)
    {
        if ( strlen($codVerificador) > 0 && strlen($numeroRegistro) > 0 )
        {
            return $this->findOneRecursive( $this->msql()->addEqualCondition('basdocumentogerado.codigoverificador', $codVerificador)
                                                         ->addEqualCondition('basdocumentogerado.numeroregistro', $numeroRegistro) );
        }
        else if ( strlen($codVerificador) > 0 && !strlen($numeroRegistro) > 0 )
        {
            return $this->findOneRecursive( $this->msql()->addEqualCondition('basdocumentogerado.codigoverificador', $codVerificador) );
        }
        else if ( !strlen($codVerificador) > 0 && strlen($numeroRegistro) > 0 )
        {
            return $this->findOneRecursive( $this->msql()->addEqualCondition('basdocumentogerado.numeroregistro', $numeroRegistro) );
        }
        
        return '';
    }
    
    /**
     * @return BasDocumentoGerado
     */
    public function buscaPeloNumeroDeRegistro($cod)
    {
        return $this->findOneRecursive( $this->msql()->addEqualCondition('basdocumentogerado.numeroregistro', $cod) );
    }
    
    /**
     * Tarefa agendada que remove os documentos antigos, para nao consumir espaco desnecessario em disco.
     * 
     * @return boolean
     */
    public static function removerArquivosAntigos(BasSystemTask $bst = null)
    {
        $doc = new BasDocumentoGerado();
        $busFile = new BusinessBasicBusFile();
        
        // busca documentos cujos dias ultrapassam o limite e tenham arquivos ainda
        $rows = $doc->findMany(
            $doc->msql()
                ->setWhereAnd('EXTRACT(days FROM (NOW() - basdocumentogerado.datageracao)) >= ?', array( SAGU::getParameter('BASIC', 'DIAS_DOWNLOAD_DOCUMENTO') ))
                ->setWhereAnd('basdocumentogerado.fileId IS NOT NULL')
        );
        
        foreach ( $rows as $row )
        {
            $row instanceof BasDocumentoGerado;
            
            $fileId = $row->fileid;
            
            // Limpa fileId
            $row->fileid = SType::NULL_VALUE;
            $row->save();
            
            $busFile->deleteFile($fileId);
        }
        
        return true;
    }
}
?>