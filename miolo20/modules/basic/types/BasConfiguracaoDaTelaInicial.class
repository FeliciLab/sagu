<?php

/**
 * <--- Copyright 2005-2012 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Type da configurao da tela inicial.
 *
 * @author Daniel Hartmann [daniel@solis.coop.br]
 *
 * \b Maintainers: \n
 * Daniel Hartmann [daniel@solis.coop.br]
 *
 * @since
 * Class created on 22/03/2012
 *
 */
class BasConfiguracaoDaTelaInicial extends SType
{
    /**
     * Constantes de posio. 
     */
    const TOPO = 't';
    const ESQUERDA = 'e';
    const DIREITA = 'd';

    /**
     * @AttributeType integer
     */
    protected $configuracaoId;

    /**
     * @AttributeType character varying
     */
    protected $login;

    /**
     * @AttributeType character varying Cdigo do widget.
     */
    protected $widget;

    /**
     * @AttributeType character Posio do widget na tela. Utilizar as constantes desta classe TOPO, ESQUERDA e DIREITA.
     */
    protected $posicao;

    /**
     * @AttributeType integer Ordem de exibio dos widgets.
     */
    protected $ordem;

    /**
     * @param integer $configuracaoId Id da configurao, caso deseja popular o objeto.
     */
    public function __construct($configuracaoId=NULL)
    {
        if ( (strlen($configuracaoId) > 0 ) )
        {
            $this->configuracaoId = $configuracaoId;
            $this->populate();
        }
    }

    /**
     * Busca as configuraes de acordo com os filtros informados.
     *
     * @param object $filters Filtros.
     * @return array Vetor de instncias de BasConfiguracaoDaTelaInicial.
     */
    public static function search($filters)
    {
        $sql = 'SELECT configuracaoid,
                       login,
                       widget,
                       posicao,
                       ordem
                  FROM basconfiguracaodatelainicial';
        $where = '';

        foreach ( $filters as $key => $value )
        {
            if ( (is_scalar($value)) && (strlen($value) > 0) )
            {
                $where.=" AND {$key} = '{$value}'";
            }
        }

        if ( strlen($where) > 0 )
        {
            $sql.=' WHERE ' . substr($where, 5);
        }

        $sql.=' ORDER BY configuracaoid ';
        $result = SDatabase::query($sql);
        $retVal = array();

        if ( $result )
        {
            foreach ( $result as $linha )
            {
                $configuracao = new BasConfiguracaoDaTelaInicial();

                list(
                    $configuracao->configuracaoId,
                    $configuracao->login,
                    $configuracao->widget,
                    $configuracao->posicao,
                    $configuracao->ordem,
                ) = $linha;

                $retVal[] = $configuracao;
            }
        }

        return $retVal;
    }

    /**
     * Busca as configuraes para exib-las na grid.
     *
     * @param object $filters Filtros.
     * @param string $colunas Colunas a serem retornadas na consulta.
     * @return array Matriz com o resultado da consulta.
     */
    public static function searchGrid($filters=NULL, $colunas='configuracaoid,login,widget,posicao,ordem')
    {
        $sql = "SELECT $colunas
                  FROM basconfiguracaodatelainicial";
        $params = array( );

        if ( strlen($filters->configuracaoId) > 0 )
        {
            $where.=' AND configuracaoid = ?';
            $params[] = $filters->configuracaoId;
        }

        if ( strlen($filters->login) > 0 )
        {
            $where.=' AND UNACCENT(login) ILIKE UNACCENT(?) ';
            $params[] = $filters->login . '%';
        }

        if ( strlen($filters->widget) > 0 )
        {
            $where.=' AND UNACCENT(widget) ILIKE UNACCENT(?) ';
            $params[] = $filters->widget . '%';
        }

        if ( strlen($filters->posicao) > 0 )
        {
            $where.=' AND posicao = ?';
            $params[] = $filters->posicao;
        }

        if ( strlen($filters->ordem) > 0 )
        {
            $where.=' AND ordem = ?';
            $params[] = $filters->ordem;
        }

        if ( strlen($where) > 0 )
        {
            $sql.=' WHERE ' . substr($where, 4) . '
                   ORDER BY configuracaoid';
            $result = SDatabase::query(SAGU::prepare($sql, $params));
        }

        return $result;
    }

    /**
     * Popula os dados do objeto de acordo com a chave primria.
     *
     * @throws Exception No caso de registro inexistente.
     */
    private function populate()
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $sql = 'SELECT username,
                       TO_CHAR(datetime, \'' . SAGU::getParameter('BASIC', 'MASK_TIMESTAMP') . '\'),
                       ipaddress,
                       configuracaoid,
                       login,
                       widget,
                       posicao,
                       ordem
                  FROM basconfiguracaodatelainicial
                 WHERE configuracaoid = ?';
        $result = SDatabase::query($sql, array( $this->configuracaoId ));

        if ( !strlen($result[0][0]) )
        {
            throw new Exception(_M('Registro inexistente.', $module));
        }

        list($this->username, $this->datetime, $this->ipaddress, $this->configuracaoId, $this->login, $this->widget, $this->posicao, $this->ordem) = $result[0];
    }

    /**
     * Insere ou atualiza registro na base, de acordo com os dados existentes no objeto.
     *
     * @return boolean Retorna true se registro foi salvo com sucesso.
     */
    public function save()
    {
        if ( strlen($this->configuracaoId) == 0 )
        {
            $retVal = $this->insert();
        }
        else
        {
            $retVal = $this->update();
        }

        return $retVal;
    }

    /**
     * Insere o objeto na base.
     *
     * @return boolean Retorna true se registro foi inserido com sucesso.
     */
    private function insert()
    {
        $sql = 'INSERT INTO basconfiguracaodatelainicial 
                            (configuracaoid, login, widget, posicao, ordem)
                     VALUES (?, ?, ?, ?, ?)';
        $sqlPK = "SELECT nextval('basconfiguracaodatelainicial_configuracaoid_seq'::regclass)";
        $result = SDatabase::query($sqlPK);
        $configuracaoId = $result[0][0];
        $params = array( $configuracaoId, $this->login, $this->widget, $this->posicao, $this->ordem );
        $result = SDatabase::execute($sql, $params, FALSE);

        if ( $result )
        {
            $this->configuracaoId = $configuracaoId;
        }

        return $result;
    }

    /**
     * Atualiza registro na base.
     *
     * @return boolean Retorna true se registro foi atualizado com sucesso.
     */
    private function update()
    {
        $sql = 'UPDATE basconfiguracaodatelainicial
                   SET login = ?,
                       widget = ?,
                       posicao = ?,
                       ordem = ?
                 WHERE configuracaoid = ?';
        $params = array( $this->login, $this->widget, $this->posicao, $this->ordem, $this->configuracaoId );
        return SDatabase::execute($sql, $params, FALSE);
    }

    /**
     * Remove registro da base.
     *
     * @return boolean Retorna true se registro foi removido com sucesso.
     * @throws Exception 
     */
    public function delete()
    {
        if ( strlen($this->configuracaoId) == 0 )
        {
            throw new Exception(_M('No  possvel excluir um registro que ainda no foi salvo.', $module));
        }

        $sql = 'DELETE FROM basconfiguracaodatelainicial
                      WHERE configuracaoid = ?';
        $params = array( $this->configuracaoId );
        $result = SDatabase::execute($sql, $params);

        if ( $result )
        {
            $this->configuracaoId = NULL;
        }

        return $result;
    }

    /**
     * @return array Lista de posies possveis para os widgets.
     */
    public static function listarPosicoes()
    {
        return array(
            self::TOPO => _M('Em cima'),
            self::ESQUERDA => _M('Na esquerda'),
            self::DIREITA => _M('Na direita'),
        );
    }
}

?>