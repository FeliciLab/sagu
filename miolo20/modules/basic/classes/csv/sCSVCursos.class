<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Gerencia importacao de movimentacoes contratuais para o SAGU
 *
 * @author Fabiano Tomasini [fabiano@solis.coop.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Fabiano Tomasini [fabiano@solis.coop.br]
 *
 * @since
 * Class created on 27/06/2012
 *
 **/
class sCSVCursos extends sCSVFileImporter
{
    public function getTitle()
    {
        $module = SAGU::getFileModule(__FILE__);
        return _M('Cursos', $module);
    }
    
    public function __construct()
    {
        $typeDefs = array('name', 'label', 'isRequired', 'type' );
        $defs = array(
            //Curso
            array( 'codCurso', _M('Codigo do curso'), true ),
            array( 'grauFormacao', _M('Grau de formacao'), true ),
            array( 'abrevGrauFormacao', _M('Abrev Grau formacao'), true ),
            array( 'nomeCurso', _M('Nome'), true ),
            array( 'abreviatura', _M('Abreviatura'), true ),
            array( 'sigla', _M('Sigla'), false ),
            array( 'nomeDoCentro', _M('Nome do centro'), false ),
            array( 'abreviaturaCentro', _M('Abreviatura do centro'), false ),
            array( 'areaConhecimento', _M('Area de conhecimento'), false ),
            array( 'dataInicialCurso', _M('Data inicial do curso'), false ),
            array( 'dataFinalCurso', _M('Data final do curso'), false ),
            array( 'dataReconhecimento', _M('Data de reconhecimento'), false ),
            array( 'numeroDocReconhecimento', _M('Numero documento de reconhecimento'), false ),
            array( 'observacoes', _M('Observacoes'), false ),
            array( 'exigenciasCurso', _M('Exigencias para o curso'), false ),
            array( 'areaDeEnsino', _M('Area de ensino'), false ),
            array( 'grauAcademico', _M('Grau academico'), false ),
            //Versao
            array( 'versao', _M('Versao'), true ),
            array( 'modalidade', _M('Modalidade'), true ),
            array( 'dataInicial', _M('Data inicial'), false ),
            array( 'dataFinal', _M('Data final'), false ),
            array( 'totalDePeriodos', _M('Total de periodos'), false ),
            array( 'descricaoPeriodo', _M('Descricao do periodo'), false ),
            array( 'creditos', _M('Creditos'), false ),
            array( 'totalDeHoras', _M('Total de horas'), false ),
            array( 'horasRequeridas', _M('Horas requeridas'), false ),
            //Ocorrencia
            array( 'turnoDescricao', _M('Turno descricao'), true ),
            array( 'turnoAbreviatura', _M('Turno abreviatura'), true ),
            array( 'turnoIdentificador', _M('Turno identificador'), true ),
            array( 'unidade', _M('Unidade'), true ),
            array( 'nomeDaCidade', _M('Nome da cidade'), false ),
            array( 'cepDaCidade', _M('Cep da cidade'), false ),
            array( 'ufCidade', _M('UF da cidade'), false, bCSVColumn::TYPE_ESTADO ),
            array( 'nomePais', _M('Nome do pais'), false ),
            array( 'dataDeAutorizacao', _M('Data de autorizacao'), true ),
            array( 'documentoDeAutorizacao', _M('Documento de autorizacao'), false ),
            array( 'estaAtivo', _M('Esta ativo'), true, bCSVColumn::TYPE_BOOLEAN ),
            array( 'tempoMinimo', _M('Tempo minimo para concl. curso'), false),
            array( 'tempoMaximo', _M('Tempo maximo para concl. curso'), false),
        );
   
        
        $this->setColumnsArray($typeDefs, $defs);
        
        parent::__construct();
    }
    
    public function importLine2($data)
    {
        //Insere curso
        $dataCurso = new stdClass();
        $dataCurso->courseId = $data->codCurso;
        $dataCurso->formationLevelId = $this->obterGrauDeFormacao($data->grauFormacao, $data->abrevGrauFormacao);
        $dataCurso->name = $data->nomeCurso;
        $dataCurso->shortName = $data->abreviatura;
        $dataCurso->acronym = $data->sigla;
        $dataCurso->centerId = $this->obterCentro($data->nomeDoCentro, $data->abreviaturaCentro);
        $dataCurso->beginDate = $data->dataInicialCurso;
        $dataCurso->moreInfo = $data->observacoes;
        $dataCurso->endDate = $data->dataFinalCurso;
        $dataCurso->knowledgeAreaId = $this->obterAreaDeConhecimento($data->areaConhecimento);
        $dataCurso->requirements = $data->exigenciasCurso;
        $dataCurso->obs = $data->observacoes;
        $dataCurso->educationAreaId = $this->obterAreaDoCurso($data->areaDeEnsino);
        
        $courseId = $this->obterCursoPeloCodigo($dataCurso->courseId);
        
        if ( strlen($courseId) > 0 )
        {
            $ok = $this->busCourse->updateCourse($dataCurso);
        }
        else
        {
            $ok = $this->busCourse->insertCourse($dataCurso);
        }        
        
        //Versao de curso
        $dataVersao = new stdClass();
        $dataVersao->courseId = $dataCurso->courseId;
        $dataVersao->courseVersion = $data->versao;
        $dataVersao->beginDate = $data->dataInicial;
        $dataVersao->endDate = $data->dataFinal;
        $dataVersao->periodTotal = $data->totalDePeriodos;
        $dataVersao->periodDescription = $data->descricaoPeriodo;
        $dataVersao->credits = $data->creditos;
        $dataVersao->hourTotal = $data->totalDeHoras;
        $dataVersao->hourRequired = $data->horasRequeridas;
        $dataVersao->courseVersionTypeId = $this->obterModalidadeVersaoCurso($data->modalidade);
        
        $objectCourseVersion = $this->busCourseVersion->getCourseVersion($dataVersao->courseId, $dataVersao->courseVersion);

        if ( strlen($objectCourseVersion->courseVersion)>0 )
        {
            $this->busCourseVersion->updateCourseVersion($dataVersao);
        }
        else
        {
             $this->inserirVersaoDeCurso($dataVersao);
        }

        //Ocorrencia de curso
        $dataOcorrencia = new stdClass();
        $dataOcorrencia->courseId = $dataCurso->courseId;
        $dataOcorrencia->courseVersion = $dataVersao->courseVersion;
        $dataOcorrencia->turnId = $this->obterTurno($data->turnoDescricao, $data->turnoAbreviatura, $data->turnoIdentificador);
        $dataOcorrencia->unitId = $this->obterUnidade($data->unidade);
        $dataOcorrencia->authorizationDate = $data->dataDeAutorizacao;
        $dataOcorrencia->status = $data->estaAtivo;
        $dataOcorrencia->minimumConclusionCourse = $data->tempoMinimo;
        $dataOcorrencia->maximumConclusionCourse = $data->tempoMaximo;
        $dataOcorrencia->authorizationDocument = $data->documentoDeAutorizacao;

        $ocorrencia = $this->busCourseOccurrence->getCourseOccurrence($dataOcorrencia->courseId, $dataOcorrencia->courseVersion, $dataOcorrencia->turnId, $dataOcorrencia->unitId);

        if( strlen($ocorrencia->courseId)>0 )
        {
            $this->busCourseOccurrence->updateCourseOccurrence($dataOcorrencia);
        }
        else
        {
            $this->busCourseOccurrence->insertCourseOccurrence($dataOcorrencia);
        }
        
        //Importa reconhecimentos somente se existe numero de documento de reconhecimento
        if ( strlen($data->numeroDocReconhecimento)>0 )
        {
            //Verifica se reconhecimento ja existe para o curso
            $filters = new stdClass();
            $filters->courseId = $dataOcorrencia->courseId;
            $filters->courseVersion = $dataOcorrencia->courseVersion;
            $filters->turnId = $dataOcorrencia->turnId;
            $filters->unitId = $dataOcorrencia->unitId;
            $filters->dataReconhecimento = $data->dataReconhecimento;
            $filters->documentoReconhecimento = $data->numeroDocReconhecimento;
            $reconhecimentoSearch = AcdReconhecimentoDeCurso::search($filters);
            
            //Insere ou atualiza reconhecimento de curso
            $reconhecimento = new AcdReconhecimentoDeCurso();
            $reconhecimento->reconhecimentoDeCursoId = $reconhecimentoSearch[0]->reconhecimentoDeCursoId;
            $reconhecimento->courseId = $dataOcorrencia->courseId;
            $reconhecimento->courseVersion = $dataOcorrencia->courseVersion;
            $reconhecimento->turnId = $dataOcorrencia->turnId;
            $reconhecimento->unitId = $dataOcorrencia->unitId;
            $reconhecimento->documentoReconhecimento = $data->numeroDocReconhecimento;
            $reconhecimento->dataReconhecimento = $data->dataReconhecimento;
            
            $reconhecimento->save();
        }
        
        return parent::importLineEnd($data);
    }
}
?>