<?php

/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Gerencia importacao de atividades complementares para o SAGU
 *
 * @author Lus Felipe Wermann [luis_felipe@solis.com.br]
 *
 * @version $Id$
 *
 * @since
 * Class created on 03/11/2014
 *
 **/
class sCSVAvaliacaoDosAlunos extends sCSVFileImporter
{
    public function getTitle()
    {
        $module = SAGU::getFileModule(__FILE__);
        return _M('Avaliao dos Alunos', $module);
    }
    
    public function __construct()
    {
        $typeDefs = array('name', 'label', 'isRequired', 'type', 'replaceVars' );
        $defs = array(
            array( 'cpf', _M('Identificador pessoa'), true ),
            array( 'curso', _M('Cod. do curso'), true ),
            array( 'versao', _M('Versao'), true ),
            array( 'turno', _M('Turno'), true ),
            array( 'campus', _M('Campus'), true ),
            array( 'tipoAvaliacao', _M('Tipo de avaliacao do MEC'), true),
            array( 'dataAvaliacao', _M('Data de avaliacao'), true),
            array( 'eDispensado', _M('Dispensado') ,true),
            array( 'estaPresente', _M('Presente'), true),
            array( 'mensagemAvaliacao', _M('Mensagem de avaliacao do aluno'), false),
            array( 'notaDoAluno', _M('Nota do aluno'), false)
        );
        
        $this->setColumnsArray($typeDefs, $defs);
        
        parent::__construct();
    }
    
    public function importLine2($data)
    {
        $personId = $this->obterPersonId($data->cpf);
        
        //Verifica se existe pessoa
        if ( strlen($personId) == 0 )
        {
            throw new Exception(_M("No foi encontrada nenhuma pessoa com o identificador '{$data->cpf}'."));
        }
        else
        {
            //Verifica se existe curso, versao, turno, unidade
            $curso = $this->obterCursoPeloCodigo($data->curso);
            if ( strlen ( $curso ) == 0 )
            {
                throw new Exception(_M("O curso de identificador '{$data->curso}' no est cadastrado no sistema."));
            }
            $versao = $this->obterCursoVersao($data->curso, $data->versao);
            if ( strlen ($versao) == 0)
            {
                throw new Exception(_M("A verso '{$data->versao}' do curso '{$data->curso}' no est cadastrada no sistema."));
            }
            $this->obterTurno($data->turno);
            $this->obterUnidade($data->campus);

            //Verifica se existe contrato
            $contractId = $this->obterContratoDaPessoa($personId, $data->curso, $data->versao, $data->turno, $data->campus);

            //Verifica se existe tipo de avaliacao do MEC
            $tipoAvaliacaoId = $this->obterTipoDeAvaliacaoDoMEC($data->tipoAvaliacao);

            //Verifica dispesando e esta presente
            if ($data->eDispensado == 's' || $data->eDispensado == 'S')
            {
                $insert->excused = DB_TRUE;
            }
            elseif ($data->eDispensado == 'n' || $data->eDispensado == 'N')
            {
                $insert->excused = DB_FALSE;
            }
            else
            {
                throw new Exception(_M("A pessoa com o identificador {$data->cpf} est com o atributo ' dispensado' incorreto: {$data->eDispensado}. Valores possveis: S ou N."));
            }

            if($data->estaPresente == 's' || $data->estaPresente == 'S')
            {
                $insert->isPresent = DB_TRUE;
            }
            elseif ($data->estaPresente == 'n' || $data->estaPresente == 'N')
            {
                $insert->isPresent = DB_FALSE;
            }
            else
            {
                throw new Exception(_M("A pessoa com o identificador {$data->cpf} est com o atributo 'Est presente' incorreto. Valores possveis: S ou N."));
            }

            //Verifica se a mensagem da avaliacao esta no sistema
            $data->mensagemAvaliacao = $this->fixValue($data->mensagemAvaliacao);
            if (strlen ($this->fixValue($data->mensagemAvaliacao)) > 0)
            {
                $mensagemAvaliacao = $this->obterMensagemDeAvaliacaoDosAlunos($data->mensagemAvaliacao);
            }
            
            //Verifica data
            $data->dataAvaliacao = $this->fixValue($data->dataAvaliacao);
            if (!SAGU::validaData($data->dataAvaliacao))
            {
                throw new Exception ( _M("A data de avaliao '{$data->dataAvaliacao}' no  uma data vlida."));
            }
            
            //Verifica nota
            $data->notaDoAluno = $this->fixValue($data->notaDoAluno);
            if ( SAGU::verificarVariavel($this->fixValue($data->notaDoAluno)) != SAGU::TIPO_VARIAVEL_NUMERO)
            {
                throw new Exception (_M("A nota do aluno '{$data->cpf}' no  uma nota de nmero vlida."));
            }

            //Insere novo
            $busAvaliacao = new BusinessAcademicBusTestEndCourseContract();

            $insert->testEndCourseTypeId = $tipoAvaliacaoId[0][0];
            $insert->contractId = $contractId;
            $insert->testEndCourseDate = $this->fixValue($data->dataAvaliacao);
            $insert->mensagemDeAvaliacaoDosAlunosId = $this->fixValue($mensagemAvaliacao[0][0]);
            $insert->notaDoAluno = $this->fixValue($data->notaDoAluno);

            $busAvaliacao->insertTestEndCourseContract($insert);
        }
    }
}
?>