<?php
/**
 * <--- Copyright 2011-2011 de Facimed - Faculdade de Cincias Biomtricas de Cacoal.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Employee form
 *
 * @author Miguel Fabricio Zamberlan [miguel.zamberlan@facimed.edu.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Equipe Sagu [sagu2@solis.coop.br]
 *
 * @since
 * Class created on 19/03/2011
 *
 **/

$MIOLO = MIOLO::getInstance();
$MIOLO->getClass('basic', 'lookupFields');

/**
 * Class to manipulate the Lookups
 **/
class BusinessProtocolLookup 
{
   /**
     * Auto complete for protocol subject
     *
     * @param $context (object): MIOLO Context object
     *
     * @return (object): MIOLO Gives the action evaluating the code by setContext call
     *
     **/
    public function autoCompleteSubject(&$context)
    {
        $sql = 'SELECT A.description
                  FROM ptcsubject A
                 WHERE A.subjectId = ?';
 
        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    /**
     * Lookup for subject
     *
     * @param $lookup: Lookup Object used by MIOLO
     *
     * @return MIOLO Lookup function as actions evaluated by MIOLO
     *
     **/
    public function lookupSubject(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_request('lmodule');

        $MIOLO->uses('classes/sagu.class','basic');
        $MIOLO->conf->loadConf($module);

        $subjectId = $lookup->getFilterValue('subjectId');
        $description = $lookup->getFilterValue('description');

        $lookup->addFilterField( new MTextField('subjectId', $subjectId, _M('Cdigo',$module), SAGU::getParameter('BASIC', 'FIELD_ID_LOOKUP_SIZE')) );
        $lookup->addFilterField( new MTextField('description', $description, _M('Descrio',$module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE')) );

        global $page;
        $page->onLoad('document.' . $page->name . '.description.focus()');

        $columns = array(
           new DataGridColumn('subjectId', _M('Cdigo', $module), 'left', true, null, true),
           new DataGridColumn('description', _M('Cidade', $module), 'left', true, null, true)
        );

        $sql = 'SELECT A.subjectId,
                       A.description
                  FROM ptcsubject A';

        if ( strlen($subjectId) > 0 )
        {
            $where .= ' AND A.subjectId = ?';
            $args[] = $subjectId;
        }

        if ( strlen($description) > 0 )
        {
            $where .= ' AND UNACCENT(A.description) ILIKE UNACCENT(?)';
            $args[] = '%' . $description . '%';
        }
        
        $where .= ' AND A.isactive IN (?,?) ';
        $args[] = BusinessProtocolBusSubject::TIPO_ATIVO_INTERNO;
        $args[] = BusinessProtocolBusSubject::TIPO_ATIVO_AMBOS;

        if ( strlen($where) > 0 )
        {
            $sql .= ' WHERE ' . substr($where, 5);
        }

        $sql .= ' ORDER BY A.description';

        $sqlObject = new sql();
        if ( strlen($where) == 0 )
        {
            $sql .= ' LIMIT 0';
        }

        $sqlObject->createFrom($sql,$args);
        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Localizar assunto',$module), 15, 0);
        $lookup->grid->setIsScrollable();
    }
}
?>