<?php
/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Solues Livres Ltda.
 *
 * Este arquivo  parte do programa Sagu.
 *
 * O Sagu  um software livre; voc pode redistribu-lo e/ou modific-lo
 * dentro dos termos da Licena Pblica Geral GNU como publicada pela Fundao
 * do Software Livre (FSF); na verso 2 da Licena.
 *
 * Este programa  distribudo na esperana que possa ser til, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implcita de ADEQUAO a qualquer MERCADO
 * ou APLICAO EM PARTICULAR. Veja a Licena Pblica Geral GNU/GPL em
 * portugus para maiores detalhes.
 *
 * Voc deve ter recebido uma cpia da Licena Pblica Geral GNU, sob o ttulo
 * "LICENCA.txt", junto com este programa, se no, acesse o Portal do Software
 * Pblico Brasileiro no endereo www.softwarepublico.gov.br ou escreva para a
 * Fundao do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Formulrio esqueci minha senha do mdulo de servios
 *
 * @author Fabiano Tomasini [fabiano@solis.coop.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 *
 * @since
 * Class created on 23/02/2011
 */
class FrmForgottenPassword extends SForm
{
    /**
     * Class constructor
     **/
    public function __construct()
    {
        $module = SAGU::getFileModule(__FILE__);
        parent::__construct(_M('Esqueci minha senha', $module), null, null);
    }

    /**
     * Default method to define fields
     **/
    public function defineFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        //Mensagem
        $fields[] = $instMsg = new MText('instMsg', _M('Os seus dados devem ser encontrados na base de dados. Por favor, preencha seu CPF ou seu email. Se sua conta for encontrada, um email ser enviado para o seu endereo de email, com instrues sobre como restabelecer seu acesso.', $module) );
        $fields[] = new MSeparator();

        // Field CPF
        $fields[] = $cpf = new MTextField('cpf', $this->getFormValue('cpf', $data->cpf), _M('CPF',$module),20);
        $cpf->setJsHint(_M('Informe o CPF', $module));
        $validators[] = new MCPFValidator('cpf', _M('CPF',$module), 'optional');

        // Field email
        $fields[] = $email = new MTextField('email', $this->getFormValue('email',$data->email), _M('E-mail',$module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_SIZE'));
        $email->setJsHint(_M('Informe o e-mail da pessoa',$module));
        $validators[] = new MEmailValidator('email',_M('E-mail',$module),'optional');

        $button[] = new MButton('submit_button',  _M('Enviar', $module));
        $button[] = new MButton('back_button',  _M('Voltar', $module), 'javascript:history.go(-1)');
        $fields[] = new MHContainer('hctButtons', $button);
        
        $this->setFields($fields);
        $this->setValidators($validators);
    }

    /**
     * Ao do boto enviar
     */
    public function submit_button_click($sender=NULL)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        // Dados do form
        $data = $this->getData();

        // Se cpf ou email tiver preenchido
        if ( (strlen($data->cpf)>0) || (strlen($data->email)>0) )
        {
            try
            {
                // Business pessoa fsica
                $busPhysicalPerson = new BusinessBasicBusPhysicalPerson();

                // Busca pela pessoa dos dados informados
                $filters = new stdClass();
                $filters->content = $data->cpf;
                $filters->email = $data->email;
                $personData = $busPhysicalPerson->searchPhysicalPersonByDocumentOrEmail($filters);
                // Cdigo da pessoa
                $personId = $personData[0][0];

                // Verifica se encontrou a pessoa
                if( !is_array($personData) )
                {
                    $msg = _M('No existe um usurio para os dados informados', $module);
                    throw new Exception($msg);
                }
                
                // Pessoa
                $person = $busPhysicalPerson->getPhysicalPerson($personId);

                // Business user
                $busUser = new BusinessAdminBusUser();
                $mioloUser = $busUser->getUserByLogin($person->mioloUserName);

                // Verifica se encontrou login
                if( !strlen($mioloUser->login)>0 )
                {
                    $msg = _M('No existe um login para esse usurio', $module).'.';
                    throw new Exception($msg);
                }

                // Insere hash na tabela basResetPassword
                $basResetPassword = new BusinessBasicBusResetPassword();

                $dataResetPassword = new stdClass();
                $dataResetPassword->idUser = $mioloUser->idUser;
                $hash = $basResetPassword->insertResetPassword($dataResetPassword);

                // Envia email com link para mudar senha
                $emailSent = false;

                // Business email and company
                $busEmail = new BusinessBasicBusEmail();
                $busCompany = new BusinessBasicBusCompany();

                //TODO email hardcode
                $dataEmail = $busEmail->getEmail(SAGU::getParameter('basic','EMAIL_ID_CHANGE_PASSWORD'));
                $dataCompany = $busCompany->getCompany(SAGU::getParameter('BASIC', 'DEFAULT_COMPANY_CONF'));

                // Pega url do joomla caso tenha
                $urlJoomla = urldecode(MIOLO::_REQUEST('parentUrl'));
                if( $urlJoomla )
                {
                    $arrayUrlJoomla = explode('?', $urlJoomla);
                    $hostJoomla = 'http://'. $arrayUrlJoomla[0];
                    $changePassword = '?option=com_changePassword';

                    $data->linkChangePassword = $hostJoomla.$changePassword.'&id='.$hash;
                }
                else
                {
                    $urlSagu = $MIOLO->getCurrentUrl();
                    $arrayUrlSagu = explode('?',$urlSagu);
                    $hostSagu = $arrayUrlSagu[0];
                    $changePassword = '?module=admin&action=changePassword';

                    $data->linkChangePassword = $hostSagu.$changePassword.'&id='.$hash;
                }

                // Verifica se a a pessoa tem e email e envia a notificao de troca de senha
                if ( strlen($person->email) > 0 || strlen($person->emailAlternative) > 0 )
                {
                    $email = ($data->email == $person->email) ? $person->email : $person->email;
                    
                    $tags = array( '$PERSONNAME' => $person->name,
                                   '$PERSONID' => $person->personId,
                                   '$LINK' => $data->linkChangePassword );

                    //Parameters
                    $from = strtolower($dataEmail->from);
                    $fromName = $dataCompany->acronym;
                    $recipient[$person->name] = strtolower($email);
                    $subject = $dataEmail->subject;
                    $body = strtr($dataEmail->body, $tags);

                    $mail = new sendEmail($from, $fromName, $recipient, $subject, $body, array());

                    if ( $mail->sendEmail() )
                    {
                        $this->AddInfo(_M('Um email para a recuperao de senha foi enviado para @1',$module, $person->email));
                    }
                    else
                    {
                        $msg = _M('Erro com o servidor de email. Entre em contato com o responsvel pelo sistema para resolver o problema', $module).'.';
                        throw new Exception($msg);
                    }
                }
            }
            catch (Exception $e)
            {
                $this->AddError( $e->getMessage() );
            }
        }
        else
        {
            $msg = _M(' necessrio informar pelo menos seu CPF ou email',$module).'.';
            $this->AddAlert($msg);
        }
    }
}
?>