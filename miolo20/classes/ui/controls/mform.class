<?php
define ('FORM_SUBMIT_BTN_NAME', 'submit_button');

/**
 * Brief Class Description.
 * Complete Class Description.
 */
class MForm extends MControl
{
/**
 * Attribute Description.
 */
    var $title;

/**
 * Attribute Description.
 */
    var $action;

/**
 * Attribute Description.
 */
    var $method;

/**
 * Attribute Description.
 */
    var $buttons;

/**
 * Attribute Description.
 */
    var $fields=array();

/**
 * Attribute Description.
 */
    var $return;

/**
 * Attribute Description.
 */
    var $reset;

/**
 * Attribute Description.
 */
    var $styles;

/**
 * Attribute Description.
 */
    var $help;

/**
 * Attribute Description.
 */
    var $footer;

/**
 * Attribute Description.
 */
    var $width;

    /**
     * @var boolean Set whether MForm must show field hints.
     */
    public static $showHints = true;

/**
 * Attribute Description.
 */
    var $enctype;

/**
 * Attribute Description.
 */
    var $validations;

/**
 * Attribute Description.
 */
    var $defaultButton;

/**
 * Attribute Description.
 */
    var $errors;

/**
 * Attribute Description.
 */
    var $infos;

/**

 * Attribute Description.
 */
    var $alerts;

/**
 * Attribute Description.
 */
    var $box;

    static $fieldNum = 0;
/**
 * Attribute Description.
 */
    var $layout;

/**
 * Attribute Description.
 */
    var $cssForm = false;
    var $cssButtons;
/**
 * Attribute Description.
 */
    var $zebra = false;
/**
 * Attribute Description.
 */
    var $labelWidth = NULL;

    var $bgColor = NULL;
    var $align = NULL;

    /**
     * @var array The customs fields array.
     */
    public $mioloCustomFields;

    /**
     * @var mixed The customized id. Only set when it's an edit action on a form for custom fields.
     */
    public $mioloCustomizedId;
    
    /**
     * Campos finais
     * 
     * @var array
     */
    private $formControlFields = array();

    /**
     * This is the constructor of the Form class. It takes a title and an
     * action url as optional parameters. The action URL is typically
     * obtained by calling the <code>MIOLO->GetActionURL()</code> method.
     *
     * @param $title  (string) the form's title string
     * @param $action (string) the URL for the forms <code>ACTION</code>
     *                attribute.
     */
    function __construct($title='',$action='',$close='',$icon='', $help='')
    {
        parent::__construct();
        $this->AddStyleFile('m_forms.css');
        $this->name          = $this->page->name;
        $this->box           = new MBox($title,$close,$icon,$help);
        $this->title         = $title;
        $this->action        = $action;
        $this->method        = 'post';
        $this->return        = false;
        $this->width         = '95%';
        $this->defaultButton = true;
        $this->fields        = array();
        $this->validations   = array();
        $this->CreateFields();
        if ($this->IsSubmitted())
        {
            $this->GetFormFields(); // set the fields array with form post/get values
        }
        $this->onLoad();
    }


/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 * @param $value (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function __set($name, $value)
    {
        $this->AddControl($value);
        $this->fields[$name] = $value;
    }


/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function __get($name)
    {
        return $this->fields[$name];
    }

    public function getValidations()
    {
        return $this->validations;
    }

    public function setValidations($validations)
    {
        $this->validations = $validations;
    }    

/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function OnLoad()
    {
    }


/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function CreateFields()
    {
    }


/**
 * Brief Description.
 * Complete Description.
 *
 * @param $validator (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function AddValidator($validator)
    {
        $field = $this->{$validator->field};

        if ( !$field )
        {
            $field = $this->getFieldFromFields($validator->field, $this->fields);
            $field->validator = $validator;
        }

        if ( !$validator->label )
        {
            $validator->label = ($validator->label == '') ? $field->label : $validator->label;
        }

        $name = '_validator_' . $this->name . '_' . $validator->id . '_' . $validator->field;
        $validator->name     = strtr( $name, array('['=>'_', ']'=>'_'));
        $validator->form     = $this->name;
        $validator->max      = $validator->max ? $validator->max : 0;
        $this->validations[] = $validator;
        return $name;
    }
    
    /**
     *
     * @return array
     */
    public function getFormControlFields()
    {
        return $this->formControlFields;
    }

    /**
     * Find a field recursively on an array of MIOLO components by its name.
     *
     * @param string $fieldName Field name.
     * @param array $fields Array of MIOLO components.
     * @return object The field, if found.
     */
    public function getFieldFromFields($fieldName, $fields)
    {
        $field = NULL;

        foreach ( (array) $fields as $f )
        {
            if ( $f instanceof MTabbedBaseGroup )
            {
                $field = $this->getFieldFromFields($fieldName, $f->getTabs());
            }
            elseif ( $f instanceof MContainer )
            {
                $field = $this->getFieldFromFields($fieldName, $f->getControls());
            }
            elseif ( $f instanceof MDiv )
            {
                $field = $this->getFieldFromFields($fieldName, $f->getInner());
            }
            elseif ( is_object($f) && ($f->name == $fieldName) )
            {
                $field = $f;
                break;
            }

            if ( $field )
            {
                break;
            }
        }

        return $field;
    }

/**
 * Brief Description.
 * Complete Description.
 *
 * @param $validators (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetValidators($validators)
    {
       if (is_array($validators))
       {
          foreach($validators as $v)
          {
             $this->AddValidator($v);
          }
       }
       elseif (is_subclass_of( $validators, 'validator'))
       {
             $this->AddValidator($validators);
       }
    }


    /**
     * Detects if a form has been submitted.
     * @returns (boolean) true if the form has been submitted otherwise
     *                    false
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function IsSubmitted()
    {
        $isSubmitted = $this->defaultButton && MForm::getFormValue(FORM_SUBMIT_BTN_NAME);
        if (isset($this->buttons))
        {
            foreach($this->buttons as $b)
            {
                $isSubmitted = $isSubmitted || MForm::GetFormValue($b->name);
            }
        }
        return $isSubmitted;
    }


    /**
     * Obtains the content of this form's title. Observe, that this
     * can be anything other as a simple text string too, such as array of
     * strings and an object implementing the <code>Generate()</code> method.
     *
     * @returns (Mixed &) a reference to the title of the form
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function GetTitle()
    {
        return $this->title;
    }


    /**
     * Sets the form's title content
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $title (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetTitle($title)
    {
        $this->title = $title;
        $this->caption = $title;
        $this->box->SetCaption($title);
    }

    /**
     * Sets the form's close action
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $action (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetClose($action)
    {
        if ($this->box->boxTitle != NULL)
        {
           $this->box->boxTitle->SetClose($action);
        }
    }


    /**
     * Sets the form's icon
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $icon (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    public function SetIcon($icon)
    {
        if ($this->box->boxTitle != NULL)
        {
            $this->box->boxTitle->SetIcon($icon);
        }
    }

    function SetAlternate($color0, $color1)
    {
        $this->zebra = array($color0, $color1);
    }


    /**
     * Obtains the content title of this form's footer. Observe, that this
     * can be anything other as a simple text string too, such as array of
     * strings and an object implementing the <code>Generate()</code> method.
     *
     * @returns (Mixed &) a reference to the footer of the form
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function GetFooter()
    {
        return $this->footer;
    }

    /**
     * Form's footer.
     * Sets the form's footer content.
     *
     * @param $footer (tipo) desc
     *
     */
    function SetFooter($footer)
    {
        $this->footer = $footer;
    }


    /**
     * Obtains a submitted form fields's values and sets the array fields
     * Uses $page->Request
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function GetFormFields()
    {
       $this->_GetFormFieldValue($this->fields);
    }


/**
 * Brief Description.
 * Complete Description.
 *
 * @param $field (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function _GetFormFieldValue($field)
    {
        if ( is_array($field) )
        {
            foreach($field as $f)
            {
                $this->_GetFormFieldValue($f);
            }
        }
        else
        {
            if ($field instanceof MFormControl)
            {
                if ( $field->name )
                {
                    $defvalue = $field->GetValue();
                    $value = $this->page->Request($field->name);
                    if ( ($field instanceof MCheckBox) || ($field instanceof MRadioButton) )
                    {
                       $field->checked = (isset($value) ? ($value == $field->value) : $field->checked);
                    }
                    else
                    {
                       $field->SetValue(isset($value) ? $value : $defvalue);
                    }
                }
            }
        }
    }


    /**
     * Obtains a submitted form field's value. This is a static function.
     *
     * @returns (mixed) value of field contained in <code>$HTTP_POST_VARS</code>
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 * @param $value (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function GetFormValue($name,$value=NULL)
    {
        $result = '';
        if ( ($name != '') && ((strpos($name,'[')) === false))
        {
           $result = MIOLO::_REQUEST($name, 'ALL');
        }
        if (! isset($result))
        {
            $result = $value;
        }
        return $result;
    }


    /**
     * Sets the content of a form field to the specified value. The
     * function does this by setting both, the field's value member and the
     * global <code>$_POST</code> to remain consistency between the values.
    *
    * @param $name (string) name of the field
    * @param $value (tipo) value to set to
    *
    * @returns (none) this function returns no value
    *
    */
    function SetFormValue($name,$value)
    {
        $value = MForm::EscapeValue($value);

        if ( $this->$name )
        {
            $this->$name->SetValue($value);
        }

        $_REQUEST[$name] = $value;
    }


    /**
     * Used to escapes special characters contained in a form field's value
     * Currently, only simple and double quote characters are subsituted
     * with their corresponding HTML entities.
     *
     * This function is used internally by some of the form's methods.
     *
     * @returns (string) the translated string
     */
    private function /* PRIVATE */ EscapeValue($value)
    {
        if ( is_array($value) )
        {
            for ( $i=0, $n = count($value); $i < $n; $i++ )
            {
                $value[$i] = $this->EscapeValue($value[$i]);
            }
        }
        else
        {
            $value = str_replace('\"','&quot;',$value);
            $value = str_replace('"','&quot;',$value);
        }
        return $value;
    }


    /**
     * Adds JavaScript code which is to be executed, when the form is submitted.
     * when the form is generated, and any JS code has been registered using
     * this function, an <code>OnSubmit</code> handler is dynamically generated
     * where the code is placed.
     * <br/><br/>
     * The generated code looks like the following where stmt stands for the
     * registered statments
     *
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $jscode (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function OnSubmit($jscode)
    {
        $this->page->OnSubmit($jscode);
    }


/**
 * Brief Description.
 * Complete Description.
 *
 * @param $jscode (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function AddJsCode($jscode)
    {
        $this->page->AddJsCode($jscode);
    }


    /**
     * Sets the action URL for this form. This is the URL to which the
     * form data will be submitted. Usually, the URL is obtained by the
     * GetActionURL of the MIOLO class.
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $action (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetAction($action)
    {
        $this->action = $action;
    }


    /**
     * Sets an URL to a help document. This document will be opened via
     * JavaScript in a new window. If this URL is set, the form will display
     * a help button in it's title bar.
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $href (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function setHelp($help, $module=null, $action=null)
    {
        if ($this->box->boxTitle != NULL)
        {
            if ( $module != null &&
                 $action != null )
            {
                $class = $help;
                $content = "MIOLO_getHelp( '$class', '$module', '$action');";
            }
            else
            {
                $content = $help;
            }

            $this->box->boxTitle->setHelp($content);
        }
        else
        {
            $this->help = $help;
        }
    }

    /**
     * Obtain the list of form fields.
     *
     * @deprecated this function will be changed in the near future, so
     * don't use it anymore and keep in touch with the development team
     * to figure out, what will be the replacement.
     *
     * @returns (array) the list of form fields
     */
    private function /*PRIVATE*/ GetFields()
    {
        return $this->fields;
    }


    /**
     * This function is used to set an array of fields for the form.
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param &$fields (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetFields(&$fields)
    {
//        $this->fields = $fields; // inicializa a lista de campos
//        $this->_RegisterField($this->fields);
        $this->fields = array();
        if (!is_array($fields)) $fields = array($fields);
        $this->layout = $fields;
        $this->_RegisterField($fields);
    }


    /**
     * This function is used internally of the form framework to
     * <i>prepare</i> the form fields for the usage within the form
     * framework.
     * <br/><br/>
     * The function basically renames all fields to 'frm_' + name and
     * assigns the value from the global array <code>$HTTP_POST_VARS</code>
     * if the field has no value (null) assigned.
     *
     * @param $field (reference) to a single field or an array of fields
     *               If an array of fields is passed, the function is called
     *               recursively for each of the contained fields.
     *
     * @returns (nothing)
     */
    private function _RegisterField($field, $isNotFormControl = false)
    {
        if ( is_array($field) )
        {
            for ( $i=0, $n = count($field); $i < $n; $i++ )
            {
                $this->_RegisterField($field[$i], $isNotFormControl);
            }
        }
        elseif ($field instanceof MDiv)
        {
            $namefield = $field->id;
            $this->$namefield = $field;

            $field = $field->getInner();

            if(is_array($field) || is_object($field) )
            {
                return $this->_registerField($field, $isNotFormControl);
            }
        }
        else
        {
            $field instanceof MFormControl;
            $field->form = $this;
            
            if ( method_exists($field, 'setFieldForm') )
            {
                $field->setFieldForm($this);
                $this->formControlFields[ $field->getName() ] = $field;
            }
            
            $className = $field->className;
            if ($field instanceof MFileField)
            {
                $this->enctype='multipart/form-data';
                $this->page->setEnctype($this->enctype);
            }
            if ($field->name == $field->id)
            {
                $namefield = $field->name;
            }
            else
            {
                $namefield = $field->id;
            }
            $this->manager->Assert(!isset($this->$namefield), "Err: property [$namefield] already in use in the form [$this->title]! Choose another name to [$namefield].");
            $this->$namefield = $field;


            if ($field instanceof MFormControl)
            {
                $value = $this->page->Request($field->name);
                if ( ($field instanceof MCheckBox) || ($field instanceof MRadioButton) )
                {
                    // set checked flag of checkbox or radiobutton if the value matches
                    $field->checked = $this->page->isPostBack() ? ($value == $field->value) : $field->checked;
                }
                elseif ( ($field instanceof MIndexedControl) )
                {
                    $this->AddFields($field->controls);
                    $field->SetValue($value);
                }
                elseif (($field instanceof MInputGrid))
                {
                    $field->SetValue($value);
                }
                elseif ( $field->value == '' )
                {
                    $field->SetValue($value);
                    if ($field instanceof MContainer)
                    {
                        $this->_RegisterField($field->GetControls(), true);
                    }
                    else
                    {
                        $field->SetValue($this->EscapeValue($field->value));
                    }
                }
            }
         }
    }


    /**
     * Adds a single field to the list of form fields and optionally adds
     * a hint text for the field.
     *
     * @param $field (reference) a reference to a form field object
     * @param $hint  (string)    an optional hint for the form field
     *
     * @returns (nothing)
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $field (tipo) desc
 * @param $hint (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function AddField($field,$hint=false)
    {
        if ( $hint )
        {
            $field->SetHint($hint);
        }
        $this->_RegisterField($field);
        $this->layout[] = $field;
//        $this->fields[] = $field;
    }


/**
 * Brief Description.
 * Complete Description.
 *
 * @param $fields (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function AddFields($fields)
    {
        if (is_array($fields))
        {
           foreach($fields as $f)
              $this->AddField($f);
        }
    }


    /**
     * Adds a form button. The button is added to the list of form buttons.
     * By default, the form framework arranges the buttons at the bottom
     * of the form container from the left to the right.
     *
     * @param $label  (string) the text which will appear on the button
     * @param $name   (string) the internal button name
     * @param $action (string) the action; 'SUBMIT', 'RESET', 'REPORT' for the buttons
     *                         type attribute or a JavaScript instruction for
     *                         the button's onClick attribute
     * @see FormButton
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param &$btn (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function AddButton($btn)
    {
        if (strtoupper($btn->action == 'REPORT'))
        {
           $this->page->hasReport = true;
        }
        $this->buttons[] = $this->{$btn->GetId()} = $btn;
    }


/**
 * Brief Description.
 * Complete Description.
 *
 * @param &$btn (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetButtons($btn)
    {
        if ( is_array($btn) )
        {
            for ( $i=0, $n = count($btn); $i < $n; $i++ )
            {
                $this->SetButtons($btn[$i]);
            }
        }
        else
        {
           $this->AddButton($btn);
        }
    }

    /**
     * Set the buttons labels.
     * This function is mainly used, to change the labels of the form's
     * default buttons for submit and return.
     *
     * @param $index (integer) the 0 based index of the button
     * @param $label (string) the new button label
     */
    public function setButtonLabel( $index, $label )
    {
        $this->buttons[$index]->label = $label;
    }

    /**
     * @deprecated This method is deprecated, use setShowReturnButton instead.
     */
    public function showReturn( $state )
    {
        $this->setShowReturnButton( $state );
    }

    /**
     * Return button visibility.
     * This function can be used to show or hide the form's return button.
     *
     * @param $state (boolean) the visible state of the return button
     */
    public function setShowReturnButton( $state )
    {
        $this->return = $state;
    }

    /**
     * Post button visibility.
     * Use this method to set the visibility of the Post Button.
     *
     * @param $state (boolean) the visible state of the Post Button
     */
    public function setShowPostButton( $state )
    {
        $this->defaultButton = $state;
    }

    /**
     * @deprecated This method is deprecated, use setShowResetButton instead.
     */
    public function showReset( $state )
    {
        $this->setShowResetButton( $state );
    }

    /**
    * Reset button visibility.
    * This function can be used to show or hide the form's reset button.
    *
    * @param $state (boolean) the visible state of the reset button
    */
    public function setShowResetButton( $state )
    {
        $this->reset = $state;
    }

    /**
     * Form's hints visibility.
     * This function returns the visibility of the form's hint texts.
     *
     * @see ShowHints
     */
    public static function getShowHints()
    {
        return self::$showHints;
    }

    /**
     * Set form's hints visibility.
     * This function can be used to show or hide the form's hint texts.
     * Each form element may have a hint text associated with it. Using
     * this method, one can enable/disable the display of the texts. This
     * may be useful for implementing kind of an beginner/expert mode.
     *
     * @param $state (boolean) the visible state of the hint texts
     */
    public static function setShowHints($state)
    {
        self::$showHints = $state;
    }

    /**
     * @deprecated This method is deprecated, use setShowHints instead.
     */
    public function showHints($state)
    {
        self::setShowHints($state);
    }


    /**
     * Returns form fields list.
     * This is a placeholder function to bu the form's field list. It
     * is excpected, that the form returns a scalar list of all defined
     * fields which carry a form field value. Thus, form elements of
     * decorative purpose only should be omitted.
     * <br/><br/>
     * Derived classes such as <code>TabbedForm</code> override this
     * function to provide the list of fields independently of the form's
     * layout.
     *
     * @returns (array) a scalar array of form fields
     */
    function GetFieldList()
    {
        return $this->_GetFieldList($this->fields);
    }

    /**
     * Returns field list.
     * Internal function which takes a list of form elements possibly
     * consisting of single fields as well as arrays and returns a scalar
     * the list of fields filtering out some known decorative form fields.
     *
     * @param $allfields (array) an array of form fields
     * @returns (array) a scalar array of form fields
     */
    private function _GetFieldList($allfields)
    {
        $fields = array();
        foreach ($allfields as $f )
        {
            if ( is_array($f) )
            {
                foreach ( $f as $a )
                {
                    if (is_a($a,'BaseLabel')) continue;
                    $fields[] = $a;
                }
            }
            else
            {
                if ( is_a($f,'BaseLabel') || is_null($f->value) ) continue;
                $fields[] = $f;
            }
        }
        return $fields;
    }

    function ClearFields()
    {
        $this->fields = NULL;
        $this->layout = NULL;
    }

    function ClearButtons()
    {
        $this->buttons = NULL;
    }

    /**
     * Validate all form fields.
     * Validates all form fields to have a non-empty content
     * @param $assert (boolean) flag how to handle invalid fields;<br/>
     *                if true, an error message will be shown<br/>
     *                if false no error message will be shown and the
     *                caller can provide an appropriate action based on the
     *                return value.
     * @returns (boolean) <b>true</b> if all fields have a value;
     *                    <b>false</b> if any of the fields has been left
     *                    empty
     */
    function validateAll( $assert=true )
    {
        foreach ( $this->getFieldList() as $f )
        {
            if ( $f->name )
            {
                $required[] = $f->name;
            }
        }
        return $this->validate($required, $assert);
    }

    /**
     * Brief Description.
     * Complete Description.
     *
     * @param $assert (tipo) desc
     *
     * @returns (tipo) desc
     *
     */
    function validateRequiredFields( $assert=true )
    {
        foreach ( $this->getFieldList() as $f )
        {
            if ( $f->required )
            {
                $required[] = $f->name;
            }
        }
        return $this->Validate( $required, $assert );
    }

    /**
     * Validates the form input
     * Validate form data based on an array of required variable names.
     *
     * @param $required (array) field to be validated
     * @param $assert (boolean) should the program stop if a error
     *                          is found
     *
     * @returns (boolean) <b>true</b> if all fields have a value;
     *                    <b>false</b> if any of the fields has been left
     *                    empty
     *
     */
    function validate( $required, $assert=true )
    {   global $MIOLO,$HTTP_POST_VARS;

        $this->errors = array();
        // collect fields by label
        foreach ( $this->getFieldList() as $f )
        {
            $fields[$f->name] = $f->name;
        }
        foreach ( $required as $r )
        {
            $name  = $r;
            $label = $fields[$name];
            $MIOLO->Assert( $label,
                            "ERROR: Required field [<b><font color=red>$name</font></b>] is not defined in form!" );

            $value = $this->getFormValue( $name );
            if ( $value === '' || (is_null($value)) )
            {
                $this->errors[] = "<b>$label</b> " . _M("was not informed!");
            }
        }
        if ( $assert && count($this->errors) )
        {
            $theme =& $MIOLO->getTheme();
            $theme->setContent( $this );
            $theme->generate();
        }
        return count( $this->errors ) == 0;
    }

    /**
     * Regiter the error
     * Registers the error related to the form
     *
     * @param $err (tipo) desc
     *
     * @returns (tipo) desc
     *
     */
    function Error( $err )
    {   global $MIOLO;

        $MIOLO->logMessage('[DEPRECATED] Call method Form::Error() is deprecated -- use Form::AddError() instead!');
        $this->addError( $err );
    }

    /**
     * Adds the related form error
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $err (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function AddError($err)
    {
        if ( $err )
        {
            if ( is_array($err) )
            {
                if ( $this->errors )
                {
                    $this->errors = array_merge($this->errors,$err);
                }

                else
                {
                    $this->errors = $err;
                }
            }
            else
            {
                $this->errors[] = $err;
            }
        }
    }


    /**
     *  returns the number of error messages or 0, if no errors exist
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function HasErrors()
    {
        return count($this->errors);
    }


    /**
     * Register an information related to the form
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $info (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function AddInfo($info)
    {
        if ( $info )
        {
            if ( is_array($info) )
            {
                if ( $this->infos )
                {
                    $this->infos = array_merge($this->infos,$info);
                }

                else
                {
                    $this->infos = $info;
                }
            }
            else
            {
                $this->infos[] = $info;
            }
        }
    }


    /**
     * Returns the number of info messages or 0, if no info exist
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function HasInfos()
    {
        return count($this->infos);
    }

/**
 * Brief Description.
 * Complete Description.
 *
 * @param $alert (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function AddAlert($alert)
    {
        if ( $alert )
        {
            if ( is_array($alert) )
            {
                if ( $this->alerts )
                {
                    $this->alerts = array_merge($this->alerts,$alert);
                }

                else
                {
                    $this->alerts = $alert;
                }
            }
            else
            {
                $this->alerts[] = $alert;
            }
        }
    }


    /**
     * Returns the number of alert messages or 0, if no alert exist
     */
/**

 * Brief Description.
 * Complete Description.
 *

 * @returns (tipo) desc
 *
 */
    function HasAlerts()
    {
        return count($this->alerts);
    }



    /**
     * Get form data and put it into the classmembers
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $data (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function CollectInput($data)
    {
        foreach ( $this->GetFieldList() as $f )
        {
            $field = $f->name;
            if ( $f instanceof MSubDetail )
            {
                $data->$field = MSubDetail::getData($field);
            }
            else
            {
                if ( $field != '' )
                {
                    $value = $this->GetFormValue($field);
                    $data->$field = $value;
                }
            }
        }
        return $data;
    }

    /**
     * Obtains the fields
     * Obtains form fields in a FormData object.
     *
     * @returns (Object) Form fields
     *
     */
    function getData()
    {
        return $this->collectInput( new FormData() );
    }

    /**
     * @return object Get request data in a stdClass object.
     */
    public function getRequestData()
    {
        return (object) $_REQUEST;
    }

    /**
     * Set data on the form fields.
     * Set form fields values. A subclassed form will likely override this
     * method, in order to provide a specialized processing for the passed
     * data object. <br/><br/>
     * This method simply calls the <code>_SetData()</code> method of the
     * <code>Form</code> class.
     * @example
     * $data = new FormData();
     * $form->setData( $data );
     *
     * @param $data (Object) object containing the field values
     *
     */
    function SetData($data)
    {
        $this->_SetData($data);
    }


    /**
     * This method sets the form field values in way, that it iterates
     * thru the list of fields and sets the values of all fields matching
     * the data object attribute names.
     * <br/><br/>
     * In short it does the following<br/>
     * <blockquote>
     * <code>$frm_name = $data->name;</code>
     * <blockquote>
     * This implies that the form field names must be identical the data
     * member names.
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $data (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    private function _SetData($data)
    {
        foreach( $this->fields as $i=>$field) // ( $i=0, $n = count($this->fields); $i < $n; $i++ )
        {
            $name = $this->fields[$i]->name;
            if ( $name )
            {
                if ( ($this->fields[$i] instanceof MRadioButton) ||
                     ($this->fields[$i] instanceof MCheckBox) )
                {
                    $this->fields[$i]->checked = ( $data->$name == $this->fields[$i]->value );
                }
                elseif ( $field instanceof MSubDetail )
                {
                    MSubDetail::setData($data->$name, $name);
                }
                else
                {
                    $value = $data->$name;

                    if ( method_exists($this->fields[$i], 'setValue') )
                    {
                        $this->fields[$i]->setValue($value);
                    }

                    $_POST[$name] = $value;
                }
            }
        }
    }


    /**
     * Obtains a form field's value
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 * @param $value (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function GetFieldValue($name,$value=false)
    {
        $field = $this->fields[$name];
        return ($field ? $field->GetValue() : NULL);
    }


    /**
     * Set a form field's value
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 * @param $value (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetFieldValue($name, $value)
    {
        $field = $this->fields[$name];

        if( method_exists($field, 'setValue') )
        {
            $field->setValue( $value );
        }
    }


    /**
     * Set a form field's validator
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 * @param $value (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetFieldValidator($name,$value)
    {
        for ( $i=0, $n = count($field); $i < $n; $i++ )
        {
            if ( $name == $this->fields[$i]->name )
            {
                $this->fields[$i]->validator = $value;
                break;
            }
        }
    }


    /**
     * Get a reference for a form field
     */
    function & GetField($name)
    {
        return $this->fields[$name];
    }


    /**
     * Get a reference for a button
     */
    function & GetButton($name)
    {
        for ( $i=0, $n = count($this->buttons); $i < $n; $i++ )
        {
            if ( $name == $this->buttons[$i]->name )
            {
                return $this->buttons[$i];
            }
        }
    }


    /**
     * Get a reference for page
     */
    function & GetPage()
    {
        return $this->page;
    }


    /**
     * Set reference for page
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param &$page (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetPage(&$page)
    {
        $this->page = &$page;
    }


    /**
     * Set a form field's attribute a value
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 * @param $attr (tipo) desc
 * @param $value (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetFieldAttr($name,$attr,$value)
    {
//      $field = $this->$name;
//      $field->$attr = $value;
        $this->fields[$name]->$attr = $value;
    }


    /**
     * Get a form field's attribute value
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 * @param $attr (tipo) desc
 * @param $index (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function GetFieldAttr($name,$attr, $index=NULL)
    {
        $field = $this->fields[$name];
        if ( is_array($field->$attr) )
        {
            $a = $field->$attr;
            $value = $a[$index];
        }
        else
        {
          $value = $field->$attr;
        }
        return $value;
    }


    /**
     * Set a form field's attribute a value
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 * @param $attr (tipo) desc
 * @param $value (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetButtonAttr($name,$attr,$value)
    {
        $button = &$this->GetButton($name);
        $button->$attr = $value;
    }


    /**
     * CSS
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $name (tipo) desc
 * @param $top (tipo) desc
 * @param $left (tipo) desc
 * @param $width (tipo) desc
 * @param $position=absolute' (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetFieldCSS($name,$top,$left,$width=NULL, $position='absolute')
    {
        $field = $this->$name;
//        $top = $this->box->top + $top;
//        $left = $this->box->left + $left;
        if ($width)
        {
            $field->width = "{$width}px";
        }
        $field->top      = "{$top}px";
        $field->left     = "{$left}px";
        if ($position) $field->position = $position;
        $field->formMode = 2;
    }



/**
 * Brief Description.
 * Complete Description.
 *
 * @param $height0 (tipo) desc
 * @param $width=0 (tipo) desc
 * @param $top=0 (tipo) desc
 * @param $left=0 (tipo) desc
 * @param $buttons=0 (tipo) desc
 * @param $position=absolute' (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function SetFormCSS($height=0, $width=0, $top=0, $left=0, $buttons=0, $position='absolute')
    {
        if ($height)   $this->box->AddStyle('height',"{$height}px");
        if ($width)    $this->box->AddStyle('width',"{$width}px");
        if ($top)      $this->box->AddStyle('top',"{$top}px");
        if ($left)     $this->box->AddStyle('left',"{$left}px");
        if ($position) $this->box->AddStyle('position',$position);
        $this->cssButtons = "{$buttons}px";
        $this->cssForm    = true;
    }

    function SetBackgroundColor($bgcolor)
    {
        $this->bgColor = $bgcolor;
    }

    function SetAlign($value)
    {
        $this->align = $value;
    }

    function SetWidth($width=NULL)
    {
        if ($width) $this->box->AddStyle('width',"{$width}");
    }

    function SetHeight($height=NULL)
    {
        if ($height) $this->box->AddStyle('height',"{$height}");
    }
   /**
    * Renderize
    */
/**
 * Brief Description.
 * Complete Description.
 *
 * @param $width (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
   function SetLabelWidth($width)
   {
       $this->labelWidth = $width;
   }

/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
   function GenerateErrors()
   {
        $prompt = Prompt::Error($this->errors,'NONE','Erros');
        return $prompt;
   }


/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
   function GenerateInfos()
   {
        $prompt = Prompt::Information($this->infos,'NONE','Informações');
        return $prompt;
   }
   
/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
   function GenerateAlerts()
   {
        $prompt = Prompt::Alert($this->alerts,'NONE','Alertas');
        return $prompt;
   }



/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
   function GenerateBody()
   {
        global $MIOLO;

        $row = 0;
        $t = array();
        // optionally generate errors
        if ( $this->HasErrors() )
        {
            $t[] = $this->GenerateErrors();
        }
        if ( $this->HasInfos() )
        {
            $t[] = $this->GenerateInfos();
        }
        if ( $this->HasAlerts() )
        {
            $t[] = $this->GenerateAlerts();
        }
        $hidden = null;
        $t = array_merge($t, $this->GenerateLayoutFields($hidden));

        if( method_exists($this->page,'getLayout') )
        {
            $layout = $this->page->theme->GetLayout();
        }
        else
        {
            $layout = $this->manager->theme->GetLayout();
        }

        if ( $layout != 'print')
        {
           $buttons = $this->GenerateButtons();
           if ($buttons)
           {
              $t = array_merge($t,array($buttons));
           }
        }
        if ( $hidden )
        {
           $t = array_merge($t,$this->GenerateHiddenFields($hidden));
        }
        $t = array_merge($t,$this->GenerateScript());
//        $t[] = new MDiv('','&nbsp;','m-spacer');
        $body = new MDiv('',$t);
        return $body;
   }


/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
   function GenerateFooter()
   {
   }


/**
 * Brief Description.
 * Complete Description.
 *
 * @param &$hidden (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
   function GenerateLayoutFields(&$hidden)
   {
       $line = 0;
       $zebra = is_array($this->zebra);
       $t = array();
       if (is_array($this->layout))
       {
           $this->generateValidators($this->layout);
           foreach ( $this->layout as $f )
           {
               $row = $t[] = $this->GenerateLayoutField($f, $hidden);
               if ($zebra)
               {
                   $row->AddStyle('backgroundColor', $this->zebra[($line++) % 2]);
               }
           }
       }
       return $t;
   }

    public function generateValidators($fields)
    {
        foreach ( $fields as $field )
        {
            if ( $field instanceof MContainer )
            {
                $this->generateValidators($field->getControls());
            }
            elseif ( $field instanceof MDiv )
            {
                $this->generateValidators((array)$field->getInner());
            }
            elseif ( $field->validator != NULL && $field->validator instanceof MValidator )
            {
                $this->addValidator($field->validator);
                $validator = $this->getFieldValidator($field->name);

                if ( $validator )
                {
                    $field->validator = $validator;
                }
            }
            elseif ( $field instanceof MFormControl )
            {
                $field->validator = $this->getFieldValidator($field->name);
            }
        }
    }

    /**
     * @return MValidator
     */
    public function getFieldValidator($name)
    {
        foreach ( $this->validations as $validator )
        {
            if ( $validator && $validator->field == $name )
            {
                return $validator;
            }
        }
        
        return false;
    }
    
    /**
     * Obtem todos validadores do campo passado
     *
     * @return array Array de objetos MValidator
     */
    public function getFieldValidators($name)
    {
        $list = array();
        
        foreach( $this->validations as $validator )
        {
            if ( $validator && $validator->field == $name )
            {
                $list[] = $validator;
            }
        }
        
        return $list;
    }

    /**
     * Remove a validator created via Ajax.
     * It doesn't throw any error if validator doesn't exist.
     *
     * @param string $fieldId Field id.
     */
    public function removeAJAXValidator($fieldId)
    {
        // Unique identifier. Remove [] to avoid javascript errors.
        $identifier = str_replace(']', '_', str_replace('[', '_', $fieldId));
        
        $identifier = str_replace('.', '_', $identifier);

        $this->page->addAJAXJsCode("delete window.MIOLO_validators.$identifier;");
    }

    /**
     * Brief Description.
     * Complete Description.
     *
     * @param $field (tipo) desc
     * @param &$hidden (tipo) desc
     *
     * @returns (tipo) desc
     *
     */
    public function GenerateLayoutField($field, &$hidden)
    {
        if ( is_array($field) )
        {
            $c = array();
            foreach ( $field as $fld )
            {
                if ( $fld->visible )
                {
                    $c[] = $fld;
                }
            }
            $field = new MHContainer('', $c);
            $field->showLabel = true;
        }

        if ( !$field->visible )
        {
            return;
        }

        $rowContent = NULL;
        $label = $field->label;
        if ( ( ( ($field->className == 'textfield') || ($field->className == 'mtextfield')) && ($field->size == 0) ) || ($field instanceof MHiddenField) )
        {
            $hidden[] = $field;
            return;
        }
        if ( $field->maintainstate )
        {
            $hidden[] = $field;
        }
        if ( $field->cssp )
        {
            return $field;
        }

        if ( ($field->formMode != MFormControl::FORM_MODE_SHOW_SIDE) ||
           ( ($field->formMode == MFormControl::FORM_MODE_SHOW_SIDE) && (! $label)) )
        {
            $rowContent = $field;
        }
        else
        {
            //FIXME: Nao processar label aqui, ao invez disso chamar $field->generateLabel()
            
            if ( $label != '' && $label != '&nbsp;' )
            {
                $label .= ':';
            }

            if ( $label != '' )
            {
                if ( $field->id != '' )
                {
                    $lbl = new MFieldLabel($field->id, $label);
                    $lbl->setClass(MControl::CLASS_CAPTION);
                }
                else
                {
                    $lbl = new MSpan('', $label, MControl::CLASS_CAPTION);
                }

                if ( $field->validator )
                {
                    if ( $field->validator->type == 'required' )
                    {
                        $lbl->setClass( MControl::CLASS_CAPTION_REQUIRED );
                    }
                    elseif ( is_array($this->validations) )
                    {
                        // checks if there is at least one required validator to put
                        // or not a required label (*)
                        foreach ( $this->validations as $validator )
                        {
                            if ( $validator && $validator->field == $field->name && $validator->type == 'required' )
                            {
                                $lbl->setClass( MControl::CLASS_CAPTION_REQUIRED );
                                break;
                            }
                        }
                    }
                }
                elseif ( $field instanceof MContainer && $field->showRequiredLabel )
                {
                    $lbl->setClass( MControl::CLASS_CAPTION_REQUIRED );
                }

                $slbl = $rowContent[] = new MSpan('', $lbl, 'label');
                if ( $this->labelWidth != NULL )
                {
                    $slbl->_AddStyle('width', $this->labelWidth . 'px');
                }
            }

            $sfld = new MSpan('', $field, 'field');
            $rowContent[] = $sfld;
        }
        return new MDiv('', $rowContent, "m-form-row");
    }

/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function GenerateButtons()
    {
           $ul = new MUnorderedList();
           if (isset($this->buttons) )
           {
              $ul->AddOption(new MHr);
              foreach ( $this->buttons as $b )
              {
                 if ($b->visible) $ul->AddOption($b);
              }
           }
           if ( $this->reset )
           {
              $ul->AddOption(new MButton('_reset','Limpar','RESET'));
           }
           if ( $this->return )
           {
              $ul->AddOption(new MButton('_return','Voltar','RETURN'));
           }
           $d = (count($ul->options) ? new MDiv('',$ul,'m-form-button-box') : NULL);
           return ($d ? new MDiv('',$d,'m-form-row') : NULL);
    }


/**
 * Brief Description.
 * Complete Description.
 *
 * @param $hidden (tipo) desc
 *
 * @returns (tipo) desc
 *
 */
    function GenerateHiddenFields($hidden)
    {
        $f[] = "\n<!-- START OF HIDDEN FIELDS -->\n";
        foreach ( $hidden as $h )
        {
            $f[] = new HiddenField($h->name,$h->value);
        }
        $f[] = "\n<!-- END OF HIDDEN FIELDS -->";
        return $f;
    }


    /**
     * Generate form specific script code
     */
/**
 * Brief Description.
 * Complete Description.
 *
 * @returns (tipo) desc
 *
 */
    function GenerateScript()
    {
        $f = array();
        if ( $this->validations )
        {
            // we generate the form onSubmit handler right in the body of the form
            $f[] = "\n<!-- START OF FORM SCRIPT CODE -->\n";
            $f[] =  "<script language=\"JavaScript\">\n";
//            echo "document.{$this->name}.elements[0].focus();\n";
            $this->OnSubmit("MIOLO_Validate_Input()");
            $f[] =  "\n";
            $f[] =  "/*\n";
            $f[] =  " * MIOLO Form Validation Objects\n";
            $f[] =  "*/\n";
            foreach ( $this->validations as $v )
            {
                $f[] = $v;
                $f[] = "\n";
            }
            $f[] = "var {$this->name}_validations = Array( ";
            $i   = 0;
            foreach ( $this->validations as $v )
            {
                if ( $i++ )
                {
                    $f[] = ",\n                                ";
                }
                $f[] = str_replace('.', '_', $v->name);
            }
            $f[] = " );\n";
            $f[] = "\n";
            $f[] = "</script>\n";
            $f[] = "<!-- END OF FORM SCRIPT CODE -->\n";
        }
        return $f;
    }

    function generateAJAXValidators()
    {
        $f = '';
        $f .= "\n<!-- START OF FORM SCRIPT CODE -->\n";
        $f .=  "<script language=\"JavaScript\">\n";
        if ( $this->validations )
        {
            $f .= "document.forms[0].onsubmit = function () { return MIOLO_Validate_Input(); }";
            $f .=  "\n";
            $f .=  "/*\n";
            $f .=  " * MIOLO Form Validation Objects\n";
            $f .=  "*/\n";
            foreach ( $this->validations as $v )
            {
                $f .= $v->generate();
                $f .= "\n";
            }
            $f .= "var {$this->name}_validations = Array( ";
            $i   = 0;
            foreach ( $this->validations as $v )
            {
                if ( $i++ )
                {
                    $f .= ",\n                                ";
                }
                $f .= str_replace('.', '_', $v->name);
            }
            $f .= " );\n";
            $f .= "\n";
        }
        else
        {
            $f .= "var {$this->name}_validations = Array();";
            $f .= "document.forms[0].onsubmit = function () { return MIOLO_Validate_Input(); }";
        }
        $f .= "</script>\n";
        $f .= "<!-- END OF FORM SCRIPT CODE -->\n";
        echo $f;
    }

    function Generate()
    {
        if (!isset($this->buttons))
        {
            if ($this->defaultButton)
            {
                $this->buttons[] = new FormButton(FORM_SUBMIT_BTN_NAME, 'Enviar', 'SUBMIT');
            }
        }
        $footer = $this->GenerateFooter();
        if ($this->cssForm)
        {
            $body = $this->GenerateBody();
            $this->box->SetControls(array($body));
            $this->box->SetBoxClass('m-form-css');
            return $this->box->Generate();
        }
        else
        {
            $body = new MDiv('',$this->GenerateBody(),'m-form-body');
            if (!is_null($this->bgColor)) $body->AddStyle('backgroundColor',$this->bgColor);
            $this->box->SetControls(array($body, $footer));
            $id   = $this->GetUniqueId();
            $this->box->SetBoxClass("m-form-outer");
            $form = new MDiv("frm$id", $this->box,"m-form-box");
            if (!is_null($this->align)) $form->AddBoxStyle('text-align',$this->align);
            return $form->Generate();
//            return $this->box->Generate();
        }
    }

    /**
     * Método responsável por fazer a navegação entre os campos doo formulário
     * e achar a grid
     * 
     * @param Array $campos Campos do formulário
     * @param String $gridName Nome da grid
     * 
     * @return mixed Grid encontrada, NULL caso esta não exista
     */
    protected function getGrid($campos, $gridName)
    {
        $grid = null;
        
        // Navega entre os campos
        foreach ( $campos as $field )
        {
            // Verifica se o campo é uma grid, caso seja um container
            // verifica os elementos que compõe este recursivamente
            $grid = $this->procuraGrid($field, $gridName);
            
            if( $grid )
            {
                break;
                
            }
                                    
        }
        
        return $grid;
        
    }
    
    /**
     * Procura a grid no campo
     * 
     * @param Object $field Campo do formulário
     * @param String $gridName Nome da grid
     * 
     * @return mixed Objeto da grid ou NULL
     */
    protected function procuraGrid($field, $gridName)
    {
        // Se é a grid
        if ( is_subclass_of($field, "MGrid") && $field->name == $gridName )
        {
            return $field;

        }
        
        $camposAtuais = $this->getCamposConformeContainer($field);
        
        // Se há campos no container
        if( $camposAtuais )
        {
            return $this->getGrid($camposAtuais, $gridName);

        }
        
        return null;
        
    }
    
    /**
     * Pega os campos de um dado objeto se este for um container
     * 
     * @param Object $field Campo do formulário
     * 
     * @return mixed Array com os campos do container ou NULL se o objeto informado
     * não for um container
     */
    protected function getCamposConformeContainer($field)
    {
        $camposAtuais = null;
        
        if( $field instanceof MDiv)
        {
            $camposAtuais = $field->getInner();

        }
        else if( $field instanceof MTab)
        {
            $camposAtuais = $field->getControls();

        }
        else if( $field instanceof MTabbedBaseGroup)
        {
            $camposAtuais = $field->getTabs();

        }
        
        return $camposAtuais;
        
    }
    
    public function getGridData($gridName)
    {       
        $grid = $this->getGrid($this->fields, $gridName);
        
        if ( !$grid )
        {
            return;
        }
        
        $isArrayGridMode = !isset($grid->columns[0]); // Modo array associativo de grids
        $titles = array();
        
        foreach ($grid->columns as $index => $c)
        {
            if ( $c->visible )
            {
                $titles[] = $c->title;
            }
            else
            {
                $invisibleColumns[] = $index;
            }
        }
        
        $data = $grid->getData();
        if ( !$data )
        {
            return;
        }
        
        $titleCount = count($titles);
        $visibleData = array();
        foreach ( $data as $line )
        {
            if ( $invisibleColumns )
            {
                // Remove invisible columns
                foreach ( $invisibleColumns as $index )
                {
                    unset( $line[$index] );
                }
            }
            
            $newLine = array();
            if ( $isArrayGridMode )
            {
                $keys = array_keys($grid->columns);
                
                foreach ( $keys as $columnName )
                {
                    // Caso exista um options na grid, substitui o valor
                    if ( $grid->columns[$columnName]->options )
                    {
                        $line[$columnName] = $grid->columns[$columnName]->options[$line[$columnName]];
                    }
                    
                    $newLine[] = $line[$columnName];
                }
            }
            else
            {
                $newLine = array_values(array_slice($line, 0, $titleCount));                 
            }

            $visibleData[] = $newLine;
        }

        $titles = array_values( $titles );
        return array_merge( array($titles), $visibleData );
    }

    /**
     * Add the custom fields of the given identifier.
     *
     * @param string $identifier Identifier.
     * @param string $customizedId Primary key of the main table (for editing form).
     * @param string $suffix Suffix to be added to each field name.
     * @return array The custom fields.
     */
    public function addCustomFields($identifier, $customizedId=NULL, $suffix='')
    {
        $fields = $this->getCustomFields($identifier, $customizedId, $suffix);
        
        if ( count($fields) > 0 )
        {
            $this->addFields( $fields );
        }
    }
    
    /**
     * @return array
     */
    public function getCustomFields($identifier, $customizedId=NULL, $suffix='')
    {
        $MIOLO = MIOLO::getInstance();
        
        if ( !$identifier )
        {
            return;
        }

        $this->mioloCustomizedId = $customizedId;

        // If customized id is set, then it's an edit action
        if ( isset($customizedId) )
        {
            // Load the custom fields values
            $data = MCustomValue::getFieldValues($identifier, $customizedId);
        }

        $this->mioloCustomFields = MCustomField::listByIdentifier($identifier);

        $fields = $this->generateCustomFields($this->mioloCustomFields, $data);
        
        return $fields;
    }
    
    /**
     * @return array
     */
    public function generateCustomFields($mioloCustomFields = array(), $data = null)
    {
        $fields = array();
        
        $listNoYes = array(
            'f' => _M('No'),
            't' => _M('Yes'),
        );
        
        foreach ( $mioloCustomFields as $cfield )
        {
            $cfield instanceof MCustomField;
            
            $field = NULL;
            $validator = NULL;

            $cfield->suffix = $suffix;
            $id = $cfield->getInputId();
            $value = isset($data) ? $data->$id : $cfield->defaultValue;
            $label = _M($cfield->label, MIOLO::getCurrentModule());

            if ( $cfield->isRequired() )
            {
                $validator = new MRequiredValidator($id, $label);
            }

            switch ( $cfield->fieldFormat )
            {
                case MCustomField::FORMAT_BOOLEAN:
                    $field = new MSelection($id, $value, $label, $listNoYes);
                    break;

                case MCustomField::FORMAT_DATE:
                    $field = new MCalendarField($id, $value, $label);

                    if ( $cfield->isRequired() && $cfield->isEditable() && $cfield->isVisible() )
                    {
                        $field->validator->type = 'required';
                        $validator = NULL;
                    }

                    break;

                case MCustomField::FORMAT_DECIMAL:
                    $field = new MFloatField($id, $value, $label);
                    break;

                case MCustomField::FORMAT_INTEGER:
                    $field = new MTextField($id, $value, $label);
                    $validator = new MIntegerValidator($id, $label, $cfield->isRequired() ? 'required' : 'optional');
                    break;

                case MCustomField::FORMAT_LIST:
                    $field = new MSelection($id, $value, $label, $cfield->getListValues());
                    break;
                
                case MCustomField::FORMAT_LISTSQL:
                    $field = new MSelection($id, $value, $label, $cfield->getListSQL());
                    $field->hint = $cfield->getFieldHint();
                    break;

                case MCustomField::FORMAT_LONG_TEXT:
                    $field = new MMultilineField($id, $value, $label, 25, 5, 20);
                    break;

                case MCustomField::FORMAT_TEXT:
                    $field = new MTextField($id, $value, $label);
                    break;
            }

            if ( $cfield->maxLength != 0 )
            {
                if ( !$validator )
                {
                    $validator = new MRegExpValidator($id, $label);
                }

                $validator->min = $cfield->minLength;
                $validator->max = $cfield->maxLength;
            }

            if ( $field )
            {
                if ( !$cfield->isEditable() )
                {
                    $field->setReadOnly(true);
                    $validator = NULL;
                }

                if ( !$cfield->isVisible() )
                {
                    $field->addBoxStyle('display', 'none');
                    $validator = NULL;
                }

                $fields[] = $field;
            }

            if ( $validator != NULL )
            {
                $this->addValidator($validator);
            }
        }
        
        return $fields;
    }

    /**
     * Save the custom field values.
     *
     * @param mixed $customizedId The primary key of the related table.
     * @return boolean Whether was successfully saved.
     */
    public function saveCustomFields($customizedId, $data = null, $identifier = null)
    {
        if ( strlen($identifier) > 0 )
        {
            $this->getCustomFields($identifier, $customizedId);
        }

        if ( count($this->mioloCustomFields) == 0 )
        {
            return NULL;
        }
        
        // Se nao passar dados, pega o padrao getData()
        if ( !$data )
        {
            $data = $this->getData();
        }
        
        $ok = false;

        foreach ( $this->mioloCustomFields as $cf )
        {
            $cf instanceof MCustomField;
            
            $inputId = $cf->getInputId();

            $customValue = new MCustomValue();
            $customValue->customizedId = $customizedId;
            $customValue->customFieldId = $cf->id;
            $customValue->value = $data->$inputId;
            
            // If customized id is set, then it's an edit action
            if ( isset($this->mioloCustomizedId) )
            {
                if ( $customValue->updateByData() )
                {
                    $ok = true;
                }
                else
                {
                    $ok = false;
                    break;
                }
            }
            else
            {
                if ( $customValue->insert() )
                {
                    $ok = true;
                }
                else
                {
                    $ok = false;
                    break;
                }
            }
        }

        return $ok;
    }

    /**
     * Search the custom field values through the identifier and the form data.
     *
     * @param string $identifier Custom field identifier.
     * @return array Values saved at the database.
     */
    public function searchCustomFieldValues($identifier)
    {
        if ( !count($this->mioloCustomFields) )
        {
            return NULL;
        }

        $searchData = array();
        $values = NULL;

        foreach ( $this->mioloCustomFields as $cf )
        {
            $value = MIOLO::_REQUEST($cf->getInputId());

            if ( strlen($value) )
            {
                $searchData[$cf->id] = $value;
            }
        }

        // Comentado para retornar todos dados de campos customizados na grid
//        if ( count($searchData) )
        {
            $values = MCustomValue::searchFieldValues($identifier, $searchData);
        }
        

        return $values;
    }
    
    /**
     * @return array
     */
    public function getCustomFieldValues()
    {
        $values = array();

        foreach ( $this->mioloCustomFields as $cf )
        {
            $cf instanceof MCustomField;
            $value = MIOLO::_REQUEST($cf->getInputId());

            if ( strlen($value) )
            {
                $values[$cf->getInputId()] = $value;
            }
        }
        
        return $values;
    }

    /**
     * Delete custom field values.
     *
     * @param mixed The primary key of the related table.
     * @return boolean Whether was successfully deleted.
     */
    public function deleteCustomFieldValues($customizedId)
    {
        if ( count($this->mioloCustomFields) == 0 )
        {
            return NULL;
        }

        $ok = false;

        foreach ( $this->mioloCustomFields as $cf )
        {
            $customValue = new MCustomValue();
            $customValue->customizedId = $customizedId;
            $customValue->customFieldId = $cf->id;

            $ok = $customValue->deleteByCustomizedId();
        }

        return $ok;
    }
    
    /**
     * Cria uma div com texto expansivel e recuavel pelo usuario.
     */
    public static function expansibleText($labelExpand, $labelCollapse, $text)
    {
        $divLabelExpand = md5($text);
        $divContent = md5($text) . 'b';
        
        $text = str_replace("\n", '<br />', $text);
        
        $html .= '<div id="'.$divLabelExpand.'">
                        <a href="javascript: return;"
                           onclick="document.getElementById(\''.$divContent.'\').style.display=\'block\'; document.getElementById(\''.$divLabelExpand.'\').style.display=\'none\'"
                        >'.$labelExpand.'</a>

                     </div>';
        
        $html .= '<div id="'.$divContent.'" style="display: none">
                        <a href="javascript: return;"
                           onclick="document.getElementById(\''.$divContent.'\').style.display=\'none\'; document.getElementById(\''.$divLabelExpand.'\').style.display=\'block\'">'.$labelCollapse.'</a>
                        <pre>' . $text . '</pre>
                     </div>';
        
        return $html;
    }
}

class FormData
{
}

?>
