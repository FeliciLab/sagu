<?php

class MHtmlPainter extends MBasePainter
{
    public $BR = "<br/>";
    private $control;

    private function getAttribute( $name, $value )
    {
        return " $name=\"$value\"" ;
    }


    private function getId()
    {
        try
        {
            if ( ! is_object($this->control) )
            {
                throw new Exception;
            }
        }
        catch ( Exception $e )
        {
            echo $e->getTraceAsString();
        }

        return $this->getAttribute( 'id', $this->control->getId() );
    }


    private function getClass()
    {
        return $this->getAttribute( 'class', $this->control->getClass() );
    }


    private function getName()
    {
        return $this->getAttribute( 'name', $this->control->getName() );
    }


    private function getValue()
    {
        return $this->getAttribute( 'value', $this->control->getValue() );
    }


    public function div( $control )
    {
        $this->control = $control;

        try
        {
            if (!is_object($this->control)) throw new Exception;
        }
        catch (Exception $e)
        {
            echo $e->GetTraceAsString();
        } 

        return "\n<div" . $this->getId() . $this->getClass() . $control->getAttributes( true ) . ">" . $control->getInnerToString() . "</div>";
    }


    public function span( $control )
    {
        $this->control = $control;

        return " <span" . $this->getId() . $this->getClass() . $control->getAttributes( true ) . ">" . $control->getInnerToString() . "</span>";
    }


    public function text( $control )
    {
        $this->control = $control;

        return "\n<span" . $this->getId() . $this->getClass() . $control->getAttributes( true ) . ">" . $control->value . "</span>";
    }


    public function inputHidden( $control )
    {
        $this->control = $control;

        return "\n<input type=\"hidden\"" . $this->getName() . $this->getValue() . $this->getId( ) . ">";
    }


    public function inputButton( $control )
    {
        $this->control = $control;

        return "\n<input type=\"button\"" . $this->getId() . $this->getClass() . $this->getName() . $this->getValue() .  $this->getAttribute('onclick',$control->onclick) . $control->getAttributes( true ) . ">";
    }


    public function inputText( $control )
    {
        $this->control = $control;

        return "\n<input " . $this->getAttribute('type', $control->type) . $this->getId() . $this->getClass() . $this->getName() . $this->getValue() .  $this->getAttribute('size',$control->size) . $control->getAttributes( true ) . ">";
    }


    public function inputCheck( $control )
    {
        $this->control = $control;

        return "\n<input " . $this->getAttribute('type',$control->type) . $this->getId() . $this->getName() . $this->getValue() . (($control->checked != '') ? " checked " : "") . $control->getAttributes( true ) . "><label " . $this->getAttribute('for',$control->id)  . $this->getClass() . ">" . $control->text . "</label>";
    }


    public function inputTextArea( $control )
    {
        $this->control = $control;

        return "\n<textarea " . $this->getId() . $this->getClass() . $this->getName() . $this->getAttribute('rows',$control->rows) . $this->getAttribute('cols',$control->cols) . $control->getAttributes( true ) . ">" . $control->getValue() . "</textarea>";
    }


    public function button( $control )
    {
        $this->control = $control;
        $html  = "\n<button " . $this->getId() . $this->getAttribute('type',$control->type) . $this->getClass() . $this->getName() . $this->getValue() . $this->getAttribute('onclick',$control->onclick) . $control->getAttributes( true ) . ">";
        $image = (($control->image != '') ? "<img src=\"{$control->image}\" alt=\"\">&nbsp;&nbsp;" : "");
        $text  = (($control->text != '') ? "{$control->text}" : "{$control->value}");
        $html .= $image . $text;
        $html .= "</button>";

        return $html;
    }


    public function label( $control )
    {
        $this->control = $control;

        return "\n<label " . $this->getClass() . $this->getAttribute('for',$control->getId()) . $control->getAttributes( true ) . ">" . $control->getValue() . "</label>";
    }


    public function fieldSet( $control )
    {
        $this->control = $control;
        $legend = (($control->caption != '') ? "<legend>{$control->caption}</legend>" : "");

        return "\n<fieldset " . $this->getId() . $this->getClass() . $control->getAttributes( true ) . ">" . $legend . $control->GetInnerToString() . "</fieldset>";
    }


    public function select( $control )
    {
        $this->control = $control;

        return "\n<select " . $this->getId() . $this->getClass() . $this->getName() . $control->getAttributes( true ) . ">" . $this->generateToString($control->content) . "</select>";
    }


    public function optionGroup( $control )
    {
        $this->control = $control;

        return "\n<optgroup " . $this->getId() . $this->getClass() . $this->getAttribute('label',$control->label) .  ">" . $this->generateToString($control->content) . "</optgroup>";
    }


    public function option( $control )
    {
        $this->control = $control;
        $label = ( $control->showValues ? $control->value . ' - ' : '') . $control->label; 

        return "\n<option" . $this->getValue() . ( ($control->checked != '') ? " selected " : "" ) .  ">$label</option>";
    }


    public function anchor( $control )
    {
        $this->control = $control;

        return "\n<a " . $this->getClass() . $this->getAttribute('href',$control->href) . $control->getAttributes( true ) . ">" . $control->caption . "</a>";
    }


    public function comment( $control )
    {
        $this->control = $control;

        return "\n<!-- {$control->value} -->\n";
    }


    public function header( $control )
    {
        $this->control = $control;

        return "\n<h" . $control->level . $this->getClass() . $control->getAttributes( true ) . ">" . $control->value . "</h" . $control->level . ">";
    }


    public function image( $control )
    {
        $this->control = $control;

        return "\n<img" . $this->getAttribute('src',$control->location) . $this->getId() . $this->getClass() . $this->getAttribute('title',$control->label) . $this->getAttribute('alt',$control->label) . $control->getAttributes( true ) . ">";
    }


    public function table( $control )
    {
        $this->control = $control;
        $table = $control->table;
        $html  = "\n<table " . $control->getAttributes( true ) . $this->getId( ) . $this->getName( ) . ">";

        $n = count($table);

        for($i=0; $i<$n; $i++)
        {
           $html .= "\n<tr " . $control->rowAttr[$i] . ">";
           $k = count($table[$i]);

           for($j=0; $j<$k; $j++)
           {
               $html .= "<td " . $control->cellAttr[$i][$j] . ">";
               $html .= $table[$i][$j];
               $html .= "</td>";
           }

           $html .= "\n</tr>";
        }

        $html .= "\n</table>";

        return $html;
    }


    public function unorderedList( $control )
    {
        return $control->content ? "\n<ul>" . $control->content . "\n</ul>" : "";
    }


    public function unorderedListItem( $control )
    {
        return ($type = $control->type) ?  "\n  <li" . (($type != 'circle') ? "type={$type}>" : ">") . $control->value . "  </li>" : '';
    }


    public function orderedList( $control )
    {
        return $control->content ? "\n<ol>" . $control->content . "\n</ol>" : "";
    }


    public function orderedListItem( $control )
    {
        return ($type = $control->type) ?  "\n  <li> " . $control->value . "  </li>" : '';
    }


    public function iFrame( $control )
    {
        return "\n<iframe name=\"{$control->name}\" src=\"{$control->src}\"" . $control->getAttributes( true ). ">\n</iframe>";
    }

    public function generateHeader( $page )
    {
        $compliant = $page->compliant ? "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">" : "";
        $metas     = $page->getMetas()->getValueText('',chr(13));
        $title     = $page->getTitle();
        $favicon   = $page->getFavicon();
        
        $html = 
    <<< HERE
$compliant
<html>
<head>
<title>$title</title>
$metas
$favicon
</head>
<body class="m-theme-body">
HERE;
        
        return $html;
        
    }
    
    public function page( $page )
    {
        if ( MUtil::getBooleanValue( $page->manager->getConf('options.performance.enable_ajax') ) )
        {
            $enable_ajax = 'var enable_ajax = true; ';
            $this->generateMethod = 'generateAJAX';
        }
        else
        {
            $enable_ajax = 'var enable_ajax = false; ';
        }

        //$compliant = $page->compliant ? "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">" : "";
        $theme     = $page->theme->generate();
        $onload    = $page->getOnLoad()->getValueText('',chr(13));
        $scripts   = $page->getScripts()->getTextByTemplate("<script type=\"text/javascript\" src=\"/:v/\"></script>\n");
        
        $conditionalScripts = $page->getConditionalScripts()->getValueText('', chr(13));

        if ( MUtil::getBooleanValue($page->manager->getConf('options.loading.show')) )
        {
            $jsCode = 'return miolo_onSubmit() && showLoading()';
        }
        else
        {
            $jsCode = 'return miolo_onSubmit()';
        }

        $form      = "\n<form name=\"$page->name\" method=\"post\" action=\"$page->action\" " . ($page->enctype != '' ? " enctype=\"$page->enctype\"" : '') . " onSubmit=\"$jsCode\" > $theme \n</form>\n";
        $onsubmit  = $page->getOnSubmit()->getValueText('',' && ' . chr(13));

        if ($onsubmit != '')
        {
            $onsubmit .= ' && '; 
        }
        $jscode = $page->getJsCode()->getValueText('',chr(13));

        $styleCode = json_encode($page->getStyleCode()->items);
                
        $styles = json_encode($page->getStyles()->items);
        $fixCss = 
        "<script type=\"text/javascript\">
            var items = {$styles};
            var codeItems = {$styleCode};
            var head = document.getElementsByTagName('head')[0];
            
            // Referência dos arquivos css
            for( var i = 0; i < items.length; i++ )
            {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = items[i];

                head.appendChild(link);
                
            }
            
            // Css definido nas tags style
            for( var i = 0; i < codeItems.length; i++ )
            {
                var style = document.createElement('style');

                style.innerHTML = codeItems[i];
                
                head.appendChild(style);

            }

        </script>\n";
        
        $html = 
    <<< HERE
$scripts
<script type="text/javascript">
<!--
$enable_ajax

function miolo_onload()
{
$onload
}
onload = miolo_onload;
//-->
</script>
$fixCss
$form
<script type="text/javascript">
<!--
function miolo_onSubmit()
{
    var form = document.$page->name;

    if ( form['__ISPOSTBACK'] )
    {
        form['__ISPOSTBACK'].value = 'yes';
    }

    return $onsubmit true ;
}
$jscode;
//-->
</script>
$conditionalScripts
</body>
</html>
HERE;

        return $html;
    }

}

?>
